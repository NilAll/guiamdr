<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin - Gest√£o</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>try{emailjs.init("vOaHzeApkyntx09x6");}catch(e){}</script>
    
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-user-select: none; user-select: none; }
        input, textarea, select { -webkit-user-select: text; user-select: text; }
        body { padding: 20px; background: #e9ecef; max-width: 900px; margin: 0 auto; color: #333; }
        
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .login-box { text-align: center; background: #333; padding: 40px 30px; border-radius: 10px; width: 90%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; font-size: 16px; }
        .btn-login { background: #007bff; color: white; padding: 12px; width: 100%; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; transition: background 0.2s; }
        
        .header-admin { display: none; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #343a40; padding: 15px; border-radius: 8px; color: white; }
        .btn-home { background: #007bff; color: white; padding: 8px 15px; border-radius: 6px; text-decoration: none; font-weight: bold; font-size: 14px; }
        
        .card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-top: 5px solid #ccc; }
        .card h2 { margin-top: 0; margin-bottom: 20px; font-size: 20px; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        #painelCidades { border-color: #ff5722; } #painelSorteios { border-color: #6f42c1; } #painelUsuarios { border-color: #28a745; } #painelVips { border-color: #ffc107; } #painelCategorias { border-color: #17a2b8; } #painelCadastro { border-color: #007bff; }
        
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: #fdfdfd; }
        label { font-weight: 600; font-size: 13px; color: #555; margin-top: 5px; display: block; }
        .row { display: flex; gap: 15px; } .col { flex: 1; }
        
        .manager-item { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 12px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 6px; }
        
        button { padding: 10px 15px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; font-size: 14px; }
        .btn-success { background: #28a745; width: 100%; margin-top: 10px; }
        .btn-warning { background: #ffc107; color: #333; display: inline-block; width: auto; padding: 5px 10px; margin: 0 2px; }
        .btn-danger { background: #dc3545; display: inline-block; width: auto; padding: 5px 10px; margin: 0 2px; }
        .btn-info { background: #17a2b8; color: white; display: inline-block; width: auto; padding: 5px 10px; margin: 0 2px; }
        .btn-mini { padding: 4px 8px !important; font-size: 12px; margin-left: 5px; }
        .btn-sector { background: #28a745; font-size: 10px; padding: 2px 6px; margin-right: 5px; }

        .sub-manager-container { display: none; background: #fff; margin: 5px 0 15px 15px; padding: 10px; border-left: 3px solid #17a2b8; }
        .sub-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 13px; }
        .sector-manager-container { display: none; background: #f1f8ff; margin: 5px 0 10px 15px; padding: 8px; border-left: 3px solid #28a745; border-radius: 4px; }
        .sector-item { display: flex; justify-content: space-between; padding: 5px 0; font-size: 12px; }
        .input-sub-add { width: 70% !important; display: inline-block; margin: 0; }

        .modal-icons { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .modal-icons-content { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 10px; text-align: center; }
        #inputCustomIcon { font-size: 40px; text-align: center; padding: 10px; width: 80px; margin: 0 auto 20px auto; display: block; }
        .sorteio-box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e9ecef; }
        
        .thumb-menu { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; vertical-align: middle; margin-right: 10px; background: #eee; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <img src="logo.png" style="max-width:120px; margin-bottom:20px; cursor: pointer;" alt="Logo" onclick="window.location.href='index.html'" title="Voltar para o App">
            <h3 style="color:white; margin-bottom:20px;">Acesso Administrativo</h3>
            <input id="inputUsuario" class="login-input" placeholder="Usu√°rio">
            <input id="inputSenha" type="password" class="login-input" placeholder="Senha" onkeypress="if(event.key==='Enter') fazerLogin()">
            <button class="btn-login" onclick="fazerLogin()">Entrar</button>
        </div>
    </div>

    <div class="header-admin" id="headerAdmin">
        <div><h2>Painel de Gest√£o</h2><span id="roleBadge" style="background:#ffc107; color:#333; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:bold;">...</span></div>
        <a href="index.html" class="btn-home">üè† Ver App</a>
    </div>

    <div class="card" id="painelCidades">
        <h2>üèôÔ∏è Cidades</h2><div id="listaCidades">Carregando...</div><hr style="margin:20px 0;">
        <h3 style="font-size:16px;">Cadastrar Nova Cidade</h3>
        <div class="row"><div class="col"><label>Nome</label><input id="novaCidadeNome" placeholder="Ex: S√£o Paulo"></div><div style="width:80px"><label>UF</label><input id="novaCidadeUF" placeholder="SP"></div></div>
        <div class="row"><div class="col"><label>Fundo (Link)</label><input id="novaCidadeFundo"></div><div class="col"><label>Logo (Link)</label><input id="novaCidadeLogo"></div></div>
        <div class="row"><div class="col"><label>Login</label><input id="novaCidadeLogin"></div><div class="col"><label>Senha</label><input id="novaCidadeSenha"></div></div>
        <button class="btn-success" onclick="salvarCidade()">Cadastrar Cidade</button>
    </div>
    
    <div class="card" id="painelSorteios">
        <h2>üé∞ Gest√£o de Sorteios (VIP)</h2>
        <div class="sorteio-box">
            <h3 style="margin-top:0; color:#28a745;">üü¢ Vitrine da Semana</h3>
            <div id="listaAtivosSemana" style="font-weight:bold; margin-bottom:15px;">Carregando...</div>
            
            <div style="display:flex; gap:10px;">
                <button class="btn-success" style="background:#6f42c1; flex:2;" onclick="rodarSorteioFinal()">üé≤ RODAR SORTEIO (S√°bado 17h)</button>
                <button class="btn-warning" style="background:#ff9800; color:white; flex:1;" onclick="sincronizarSorteios()">‚ôªÔ∏è Sincronizar/Corrigir</button>
            </div>
            <p style="font-size:12px; color:#666; margin-top:5px;">Se n√£o aparecer o brinde certo, clique em "Sincronizar".</p>
        </div>
        <h3>‚è≥ Fila de Espera</h3>
        <div id="listaFilaEspera"></div>
    </div>

    <div class="card" id="painelUsuarios"><h2>üë• Usu√°rios do App</h2><div id="listaUsuarios"></div><div id="formEditUser" style="display:none; background:#f0f8ff; padding:15px; border-radius:8px; margin-top:20px;"><h3 style="margin-top:0; font-size:16px;">‚úèÔ∏è Editando Usu√°rio</h3><input type="text" id="editUserName"><input type="text" id="editUserEmail" disabled><input type="text" id="editUserPass"><label>Cidade:</label><select id="editUserCidade"><option value="">Selecione...</option></select><div style="display:flex; gap:10px; margin-top:10px;"><button class="btn-success" style="width:auto;" onclick="salvarEdicaoUsuario()">Salvar</button><button class="btn-danger" style="width:auto;" onclick="cancelarEdicaoUsuario()">Cancelar</button></div></div></div>
    
    <div class="card" id="painelVips">
        <h2>üíé Membros VIP</h2>
        <div class="row"><div class="col"><label>Nome</label><input id="vipNome"></div><div class="col"><label>Nascimento</label><input type="date" id="vipNasc"></div></div>
        <label>E-mail</label><input type="email" id="vipEmail"><label>Palavra Secreta</label><input type="text" id="vipPalavra">
        <div style="display:flex; gap:10px; margin-top:10px;"><button id="btnSalvarVip" class="btn-success" onclick="salvarVip()">Cadastrar VIP</button><button id="btnCancelVip" class="btn-danger" style="display:none; width:auto;" onclick="cancelarEdicaoVip()">Cancelar</button></div>
        <hr style="margin:20px 0;"><div id="listaVips"></div>
    </div>

    <div class="card" id="painelCategorias"><h2>üìÇ Categorias e √çcones</h2><div id="listaGestaoCategorias"></div><div class="row" style="margin-top:20px;"><div class="col"><input id="novaCategoriaInput" placeholder="Nome da Nova Categoria"></div><button class="btn-success" style="width:auto; margin:5px 0 15px 0;" onclick="adicionarCategoria()">Criar</button></div></div>
    
    <div class="card" id="painelMasterConfig">
        <h2>‚öôÔ∏è Configura√ß√µes Gerais</h2>
        <label>Nome App</label><input type="text" id="confNomeCidade">
        <label>WhatsApp Admin</label><input type="number" id="confZapAdmin">
        <div class="row"><div class="col"><label>Opac. Azul</label><input type="range" id="opacAzul"></div><div class="col"><label>Opac. Preto</label><input type="range" id="opacPreto"></div></div>
        <div class="row"><div class="col"><label>Logo Altura</label><input id="confLogoHeight" type="number"></div><div class="col"><label>Logo Topo</label><input id="confLogoTop" type="number"></div></div>
        <button onclick="salvarConfigGlobal()" style="background:#6f42c1">Salvar</button>
    </div>

    <div class="card" id="painelCadastro" style="display:block;">
        <h2 id="tituloForm">üè™ Cadastrar / Editar Local</h2>
        <div class="row"><div class="col"><label style="color:#ff5722;">1. Cidade</label><select id="selCidadeCadastro" style="border:1px solid #ff5722"></select></div><div class="col"><label style="color:#007bff;">2. Categoria</label><select id="categoria" style="border:1px solid #007bff;"><option value="">Selecione...</option></select></div></div>
        <div class="row"><div class="col"><label>3. Subcategoria</label><select id="subcategoria" disabled><option value="">Selecione...</option></select></div><div class="col"><label>4. Setor</label><select id="setor" disabled><option value="">Selecione...</option></select></div></div>
        <hr style="margin:20px 0; border-top:1px solid #eee">
        <label id="lblNome">Nome do Estabelecimento</label><input id="nome">
        <div class="row"><div class="col"><label>R$ Riscado</label><input id="precoAntigo"></div><div class="col"><label>R$ Atual</label><input id="precoAtual"></div></div>
        <label id="lblCidade">Endere√ßo</label><input id="cidade"><label>Link Maps</label><input id="linkMapa"><label>Link Imagem</label><textarea id="imagem" rows="2"></textarea>
        <div class="row"><div class="col"><label>WhatsApp</label><input id="contato"></div><div class="col"><label>Fixo</label><input id="telFixo"></div></div><label>Instagram</label><input id="instagram">
        
        <div style="margin:20px 0; background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #ddd;">
            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                <label style="cursor:pointer; color:#28a745;"><input type="checkbox" id="checkDelivery" onclick="verificarTermosDelivery(this)"> üõµ Ativar Delivery</label> 
                <label style="cursor:pointer;"><input type="checkbox" id="checkPubli"> üì¢ Banner</label>
                <label style="cursor:pointer; color:#ffc107;"><input type="checkbox" id="checkPartner"> ‚≠ê Parceiro</label>
            </div>
            <small style="color:#666; display:block; margin-top:5px;">(Parceiro: Adiciona destaque dourado no App)</small>

            <div id="boxInfoDelivery" style="display:none; margin-top:15px; padding-top:15px; border-top:1px solid #ddd;">
                <h4 style="margin-bottom:10px;">üìù Criar Card√°pio (Obrigat√≥rio para Brinde)</h4>
                
                <div class="row">
                    <div class="col" style="flex:2"><input id="prodNome" placeholder="Nome do Produto"></div>
                    <div class="col"><input id="prodPreco" placeholder="Pre√ßo"></div>
                </div>
                <input id="prodImg" placeholder="Link da Imagem do Produto">
                <button class="btn-info" style="width:auto; height:35px; margin-top:5px;" onclick="addItemMenu()">Adicionar ao Menu</button>
                
                <div id="lista-cardapio-preview" style="background:white; padding:10px; border:1px solid #eee; margin-top:10px;"></div>

                <label style="color:#28a745; margin-top:20px;">üéÅ Selecione o Brinde VIP (Do Menu)</label>
                <select id="deliveryBrinde" style="border:1px solid #28a745;"><option value="">Primeiro adicione itens ao menu...</option></select>
                <p style="font-size:12px; color:#666; margin:0;">*Selecione um item do menu acima para ser o brinde.</p>
            </div>
            
            <div id="boxPubli" style="display:none; margin-top:15px;"><label>Imagem Banner</label><input id="imgPubli"></div>
        </div>
        
        <div style="display:flex; gap:10px;">
            <button id="btnSalvar" class="btn-success" onclick="salvarOuAtualizar()">Salvar Registro</button>
            <button id="btnCancelar" class="btn-danger" style="display:none" onclick="limparForm()">Cancelar</button>
        </div>
    </div>

    <div class="card" id="painelLista" style="display:block;"><h3>üìã Lista de Cadastros</h3><div id="lista-locais"></div></div>

    <div id="modalTermos" class="modal-icons"><div class="modal-icons-content">
        <h3 style="color:#28a745;">üìú Termos do Delivery</h3>
        <p style="text-align:left; font-size:14px; line-height:1.6; color:#555;">Para ativar o Delivery, concorde com:<br>1. Taxa anual de manuten√ß√£o.<br>2. Doa√ß√£o de <b>1 Brinde</b> a cada ciclo (aprox. 4 meses) para sorteio VIP.</p>
        <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;"><button class="btn-success" style="width:auto;" onclick="aceitarTermos()">Concordo</button><button class="btn-danger" style="width:auto;" onclick="recusarTermos()">Cancelar</button></div>
    </div></div>

    <div id="modalIconPicker" class="modal-icons"><div class="modal-icons-content"><h3>√çcone</h3><input type="text" id="inputCustomIcon" placeholder="üçï"><div style="margin-top:10px; display:flex; gap:10px; justify-content:center;"><button class="btn-success" style="width:auto;" onclick="salvarIconeCustomizado()">Salvar</button><button class="btn-danger" style="width:auto;" onclick="closeIconPicker()">Cancelar</button></div></div></div>

    <script type="module">
        const VERSAO_ATUAL="3.0"; 
        if(localStorage.getItem("v_adm")!==VERSAO_ATUAL){localStorage.setItem("v_adm",VERSAO_ATUAL);location.reload(true);}
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, getDoc, setDoc, onSnapshot, query, where, getDocs, orderBy, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const app=initializeApp({apiKey:"AIzaSyDsTWnP2cmsUIDeDlotoR1uELMAba_-dyw",authDomain:"testegithub-e1ffb.firebaseapp.com",projectId:"testegithub-e1ffb",storageBucket:"testegithub-e1ffb.firebasestorage.app",messagingSenderId:"508103458559",appId:"1:508103458559:web:55bc2fe4dc61d7b5ee16ca"}); 
        const db=getFirestore(app); const el=id=>document.getElementById(id);
        let currentUser=null, listaSubs={}, listaSetores={}, customIcons={}, idEditando=null, catEditing=null, idVipEditando=null, idUsuarioEditando=null, cardapio=[];

        window.fazerLogin=async()=>{const u=el('inputUsuario').value.trim(),p=el('inputSenha').value; if(!u||!p) return alert("Preencha tudo"); if(u==='master'&&p==='master123'){currentUser={role:'master'};init();return;} try{let q=query(collection(db,"cidades"),where("login","==",u),where("senha","==",p));let s=await getDocs(q);if(!s.empty){currentUser={role:'city',cityId:s.docs[0].id};init();return;} alert("Dados incorretos");}catch(e){alert("Erro conex√£o");}};
        function init(){el('loginScreen').style.display='none';el('headerAdmin').style.display='flex'; const m=currentUser.role==='master'; el('painelCidades').style.display=m?'block':'none';el('painelUsuarios').style.display=m?'block':'none';el('painelMasterConfig').style.display=m?'block':'none';el('painelSorteios').style.display=m?'block':'none'; el('painelVips').style.display='block';el('painelCategorias').style.display='block';el('painelCadastro').style.display='block';el('painelLista').style.display='block'; loadData(); if(m) carregarSorteios();}
        
        async function loadData(){
            onSnapshot(collection(db,"cidades"),s=>{el('selCidadeCadastro').innerHTML='<option value="">Selecione a Cidade</option>'; el('listaCidades').innerHTML=""; s.forEach(d=>{el('selCidadeCadastro').innerHTML+=`<option value="${d.id}">${d.data().nome}</option>`; if(currentUser.role==='master') el('listaCidades').innerHTML+=`<div class="manager-item"><b>${d.data().nome}</b></div>`;});});
            onSnapshot(doc(db,"config","categorias"),s=>{listaSubs=s.exists()?s.data():{"_order":[]};renderCats();});
            onSnapshot(doc(db,"config","setores"),s=>{listaSetores=s.exists()?s.data():{};});
            onSnapshot(doc(db,"config","icons"),s=>{customIcons=s.exists()?s.data():{};renderCats();});
            onSnapshot(doc(db,"config","geral"),s=>{if(s.exists()){const d=s.data();el('confZapAdmin').value=d.zapAdmin||"";el('confNomeCidade').value=d.titulo||"";el('opacAzul').value=d.opacAzul||80;el('opacPreto').value=d.opacPreto||50;el('confLogoHeight').value=d.logoHeight||"";el('confLogoTop').value=d.logoTop||"";}});
            onSnapshot(collection(db,"vips"),s=>{el('listaVips').innerHTML="";s.forEach(d=>el('listaVips').innerHTML+=`<div class="manager-item"><div><b>${d.data().nome}</b> (${d.data().palavra})</div><div><button class="btn-warning btn-mini" onclick="editVip('${d.id}','${d.data().nome}','${d.data().nasc}','${d.data().email}','${d.data().palavra}')">‚úèÔ∏è</button><button class="btn-danger btn-mini" onclick="delVip('${d.id}')">X</button></div></div>`);});
            let q=query(collection(db,"guia_cidades")); if(currentUser.role==='city') q=query(collection(db,"guia_cidades"),where("cidadeId","==",currentUser.cityId));
            onSnapshot(q,s=>{el('lista-locais').innerHTML="";s.forEach(d=>el('lista-locais').innerHTML+=`<div class="manager-item"><b>${d.data().nome}</b><div><button class="btn-warning btn-mini" onclick="editLocal('${d.id}','${encodeURIComponent(JSON.stringify(d.data()))}')">‚úèÔ∏è</button><button class="btn-danger btn-mini" onclick="delLocal('${d.id}')">X</button></div></div>`);});
            if(currentUser.role==='master'){onSnapshot(collection(db,"users"),(snap)=>{el('listaUsuarios').innerHTML="";snap.forEach(doc=>{const u=doc.data();el('listaUsuarios').innerHTML+=`<div class="manager-item"><div><b>${u.nome}</b> (${u.email})</div><div><button class="btn-warning btn-mini" onclick="prepararEdicaoUsuario('${doc.id}','${u.nome}','${u.email}','${u.senha}','${u.cidadeId||''}')">‚úèÔ∏è</button></div></div>`;});});}
        }

        // --- SORTEIO COM SINCRONIZA√á√ÉO FORTE ---
        function carregarSorteios(){
            const q=query(collection(db,"guia_cidades"));
            onSnapshot(q,(snap)=>{
                let ativos=[], fila=[];
                snap.forEach(d=>{
                    const item={id:d.id,...d.data()};
                    if (item.temDelivery) {
                        if(item.sorteio_ativo) ativos.push(item);
                        else fila.push(item);
                    }
                });
                fila.sort((a,b)=>(a.data_ultima_doacao?.seconds||0)-(b.data_ultima_doacao?.seconds||0));
                
                el('listaAtivosSemana').innerHTML=ativos.length?ativos.map(i=>`<div style="padding:5px;border-bottom:1px solid #eee;">üèÜ <b>${i.nome}</b> oferta: ${i.deliveryBrinde}</div>`).join(''):'<p>Nenhum brinde rodando.</p>';
                el('listaFilaEspera').innerHTML=fila.map(i=>`<div class="manager-item" style="font-size:12px;">${i.nome} (Ult. Doa√ß√£o: ${i.data_ultima_doacao?new Date(i.data_ultima_doacao.seconds*1000).toLocaleDateString():'Novo'})</div>`).join('');
            });
        }

        window.sincronizarSorteios = async () => {
            if(!confirm("Isso vai corrigir erros e puxar novos brindes se a vitrine estiver vazia. Continuar?")) return;
            const q = query(collection(db, "guia_cidades"));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            let countFix = 0;
            let temDeliveryList = [];
            let ativos = [];

            snap.forEach(doc => {
                const d = doc.data();
                // 1. Limpa Zumbis (Ativos mas sem delivery)
                if (!d.temDelivery && d.sorteio_ativo) {
                    batch.update(doc.ref, { sorteio_ativo: false });
                    countFix++;
                }
                // 2. Coleta lista real
                if (d.temDelivery) {
                    temDeliveryList.push({id: doc.id, ...d});
                    if (d.sorteio_ativo) ativos.push(d);
                }
            });

            // 3. Se n√£o tem nenhum ativo, for√ßa o pr√≥ximo da fila
            if (ativos.length === 0 && temDeliveryList.length > 0) {
                // Ordena por antiguidade
                temDeliveryList.sort((a,b) => (a.data_ultima_doacao?.seconds || 0) - (b.data_ultima_doacao?.seconds || 0));
                
                // Define quantos ativar (1 a cada 4)
                const qtd = Math.ceil(temDeliveryList.length / 4) || 1;
                const escolhidos = temDeliveryList.slice(0, qtd);
                
                for (const item of escolhidos) {
                    batch.update(doc(db, "guia_cidades", item.id), { sorteio_ativo: true });
                    countFix++;
                }
            }

            if(countFix > 0) { 
                await batch.commit(); 
                alert(`Sincroniza√ß√£o completa! ${countFix} corre√ß√µes aplicadas.`);
                window.location.reload(true); // Recarrega para ver mudan√ßas
            } else { 
                alert("Tudo parecia correto, mas forcei uma verifica√ß√£o."); 
            }
        };

        window.rodarSorteioFinal=async()=>{if(!confirm("Girar ciclo e trocar brindes?"))return; const q=query(collection(db,"guia_cidades"),where("sorteio_ativo","==",true)); const snap=await getDocs(q); if(snap.empty)return alert("Nada para sortear"); const batch=writeBatch(db); snap.forEach(d=>{batch.update(d.ref,{sorteio_ativo:false,data_ultima_doacao:new Date()});}); await batch.commit(); alert("Ciclo girado! Clique em Sincronizar se necess√°rio.");};

        // CARD√ÅPIO E BRINDE
        window.addItemMenu = () => {
            const nome = el('prodNome').value; const preco = el('prodPreco').value; const img = el('prodImg').value;
            if(!nome || !preco) return alert("Nome e Pre√ßo obrigat√≥rios");
            cardapio.push({nome, preco, img}); 
            el('prodNome').value=""; el('prodPreco').value=""; el('prodImg').value="";
            renderMenu(); atualizarSelectBrindes();
        };
        function renderMenu() {
            el('lista-cardapio-preview').innerHTML = cardapio.map((x,i)=>`
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; align-items:center; border-bottom:1px solid #f0f0f0; padding-bottom:5px;">
                    <div style="display:flex; align-items:center;">
                        ${x.img ? `<img src="${x.img}" class="thumb-menu">` : ''}
                        <span>${x.nome} - R$ ${x.preco}</span>
                    </div>
                    <button class="btn-danger btn-mini" onclick="window.removeMenu(${i})">X</button>
                </div>`).join('');
        }
        window.removeMenu = (i) => { cardapio.splice(i,1); renderMenu(); atualizarSelectBrindes(); };
        function atualizarSelectBrindes() {
            const sel = el('deliveryBrinde'); const atual = sel.value;
            sel.innerHTML = '<option value="">Selecione um item do menu...</option>';
            cardapio.forEach(item => { sel.innerHTML += `<option value="${item.nome}">${item.nome}</option>`; });
            sel.value = atual;
        }

        // SALVAR
        window.salvarOuAtualizar=async()=>{
            const temDelivery = el('checkDelivery').checked;
            const d={
                cidadeId:el('selCidadeCadastro').value, nome:el('nome').value, nomeBusca:el('nome').value.toLowerCase(),
                categoria:el('categoria').value, subcategoria:el('subcategoria').value, setor:el('setor').value,
                contato:el('contato').value, instagram:el('instagram').value, imagem:el('imagem').value,
                preco:parseFloat(el('precoAtual').value)||0, precoAntigo:parseFloat(el('precoAntigo').value)||0,
                isPartner:el('checkPartner').checked, 
                temDelivery: temDelivery,
                // FOR√áA DESATIVA√á√ÉO DO SORTEIO SE TIRAR DELIVERY
                sorteio_ativo: temDelivery ? (idEditando ? undefined : false) : false,
                deliveryBrinde:el('deliveryBrinde').value,
                cardapio: cardapio,
                publi:{ativa:el('checkPubli').checked, img:el('imgPubli').value},
                linkMapa:el('linkMapa').value, telFixo:el('telFixo').value, cidade:el('cidade').value
            };
            if (!idEditando && temDelivery) d.data_ultima_doacao = null; // Novos entram no topo da fila (null = mais antigo que datas)

            if(d.sorteio_ativo === undefined) delete d.sorteio_ativo; 
            if(temDelivery === false) d.sorteio_ativo = false;

            if(currentUser.role==='owner') d.ownerId = currentUser.userId;
            if(idEditando) await updateDoc(doc(db,"guia_cidades",idEditando),d); else await addDoc(collection(db,"guia_cidades"),d);
            alert("Salvo!"); limparForm();
        };

        // ... FUN√á√ïES DE CATEGORIA, ICONES, ETC MANTIDAS IGUAIS ...
        window.editLocal=(id,j)=>{const d=JSON.parse(decodeURIComponent(j)); idEditando=id; el('tituloForm').textContent="‚úèÔ∏è Editando: "+d.nome; el('selCidadeCadastro').value=d.cidadeId; el('nome').value=d.nome; el('cidade').value=d.cidade||""; el('categoria').value=d.categoria; el('categoria').dispatchEvent(new Event('change')); setTimeout(()=>{el('subcategoria').value=d.subcategoria; el('subcategoria').dispatchEvent(new Event('change')); el('setor').value=d.setor;},500); el('imagem').value=d.imagem; el('linkMapa').value=d.linkMapa||""; el('contato').value=d.contato||""; el('telFixo').value=d.telFixo||""; el('instagram').value=d.instagram||""; el('precoAtual').value=d.preco||""; el('precoAntigo').value=d.precoAntigo||""; el('checkPartner').checked=d.isPartner; el('checkPubli').checked=d.publi?.ativa; el('imgPubli').value=d.publi?.img||""; if(d.publi?.ativa) el('boxPubli').style.display='block'; el('checkDelivery').checked=d.temDelivery; if(d.temDelivery) el('boxInfoDelivery').style.display='block'; cardapio = d.cardapio || []; renderMenu(); atualizarSelectBrindes(); el('deliveryBrinde').value=d.deliveryBrinde||""; el('btnSalvar').innerText="Atualizar"; el('btnCancelar').style.display='inline'; el('painelCadastro').scrollIntoView({behavior:'smooth'});};
        window.limparForm=()=>{idEditando=null; el('tituloForm').textContent="üè™ Cadastrar Local"; el('nome').value=""; el('cidade').value=""; el('imagem').value=""; el('btnSalvar').innerText="Cadastrar"; el('btnCancelar').style.display='none'; el('checkDelivery').checked=false; el('boxInfoDelivery').style.display='none'; cardapio=[]; renderMenu(); atualizarSelectBrindes();};
        window.delLocal=async(id)=>{if(confirm("Apagar?"))await deleteDoc(doc(db,"guia_cidades",id));};
        window.verificarTermosDelivery = (chk) => { if(chk.checked){el('modalTermos').style.display='flex'; chk.checked=false;} else {el('boxInfoDelivery').style.display='none';} };
        window.aceitarTermos = () => { el('checkDelivery').checked=true; el('boxInfoDelivery').style.display='block'; el('modalTermos').style.display='none'; };
        window.recusarTermos = () => { el('modalTermos').style.display='none'; };
        el('checkPubli').onchange=e=>el('boxPubli').style.display=e.target.checked?'block':'none';
        function renderCats(){const d=el('listaGestaoCategorias');d.innerHTML="";(listaSubs["_order"]||[]).forEach(c=>{let ic=customIcons[c]||"üìÇ";d.innerHTML+=`<div class="manager-item"><div><b>${ic} ${c}</b> <button class="btn-info btn-mini" onclick="openIcon('${c}')">Icon</button><button class="btn-warning btn-mini" onclick="editCat('${c}')">‚úèÔ∏è</button></div><div><button class="btn-info btn-mini" onclick="toggleSubs('${c}')">Subs</button><button class="btn-danger btn-mini" onclick="delCat('${c}')">X</button></div></div><div id="subs-${c}" class="sub-manager-container">${(listaSubs[c]||[]).map((s,i)=>`<div class="sub-item"><div>${s} <button class="btn-sector" onclick="toggleSetores('${s}')">Setores</button></div><button class="btn-mini btn-danger" onclick="delSub('${c}',${i})">X</button></div><div id="setores-${s}" class="sector-manager-container">${(listaSetores[s]||[]).map((st,sti)=>`<div class="sector-item">${st} <button class="btn-mini btn-danger" onclick="delSetor('${s}',${sti})">X</button></div>`).join('')}<div style="display:flex;gap:5px"><input id="new-setor-${s}" class="input-sub-add" placeholder="Novo"><button class="btn-success btn-mini" onclick="addSetor('${s}')">Add</button></div></div>`).join('')}<div style="display:flex;gap:5px"><input id="new-sub-${c}" class="col" placeholder="Nova Sub"><button class="btn-success btn-mini" onclick="addSub('${c}')">Add</button></div></div>`;}); updateSel();}
        window.openIcon=c=>{catEditing=c;el('modalIconPicker').style.display='flex';el('inputCustomIcon').value=customIcons[c]||"";el('inputCustomIcon').focus();};
        window.closeIconPicker=()=>el('modalIconPicker').style.display='none';
        window.salvarIconeCustomizado=async()=>{const v=el('inputCustomIcon').value.trim();if(v)customIcons[catEditing]=v;else delete customIcons[catEditing];await setDoc(doc(db,"config","icons"),customIcons);closeIconPicker();};
        window.adicionarCategoria=async()=>{const n=el('novaCategoriaInput').value.trim();if(!n)return;if(!listaSubs["_order"])listaSubs["_order"]=[];listaSubs["_order"].push(n);await setDoc(doc(db,"config","categorias"),listaSubs);renderCats();el('novaCategoriaInput').value="";};
        window.delCat=async(n)=>{if(confirm("Apagar?")){listaSubs["_order"]=listaSubs["_order"].filter(x=>x!==n);delete listaSubs[n];await setDoc(doc(db,"config","categorias"),listaSubs);renderCats();}};
        window.editCat=async(old)=>{const n=prompt("Novo nome:",old);if(n&&n!==old){if(listaSubs[n])return alert("Existe");listaSubs[n]=listaSubs[old];delete listaSubs[old];const i=listaSubs["_order"].indexOf(old);if(i!==-1)listaSubs["_order"][i]=n;await setDoc(doc(db,"config","categorias"),listaSubs);renderCats();}};
        window.toggleSubs=id=>{const x=document.getElementById('subs-'+id);x.style.display=x.style.display==='block'?'none':'block';};
        window.toggleSetores=id=>{const x=document.getElementById('setores-'+id);x.style.display=x.style.display==='block'?'none':'block';};
        window.addSub=async(c)=>{const v=document.getElementById('new-sub-'+c).value.trim();if(!v)return;if(!listaSubs[c])listaSubs[c]=[];listaSubs[c].push(v);await setDoc(doc(db,"config","categorias"),listaSubs);renderCats();};
        window.delSub=async(c,i)=>{if(confirm("Apagar?")){listaSubs[c].splice(i,1);await setDoc(doc(db,"config","categorias"),listaSubs);renderCats();}};
        window.addSetor=async(s)=>{const v=document.getElementById('new-setor-'+s).value.trim();if(!v)return;if(!listaSetores[s])listaSetores[s]=[];listaSetores[s].push(v);await setDoc(doc(db,"config","setores"),listaSetores);renderCats();};
        window.delSetor=async(s,i)=>{if(confirm("Apagar?")){listaSetores[s].splice(i,1);await setDoc(doc(db,"config","setores"),listaSetores);renderCats();}};
        el('categoria').onchange=()=>{const c=el('categoria').value; const s=el('subcategoria'); s.innerHTML='<option value="">Selecione...</option>'; s.disabled=true; if(c&&listaSubs[c]){s.disabled=false;listaSubs[c].forEach(x=>s.innerHTML+=`<option value="${x}">${x}</option>`);}};
        el('subcategoria').onchange=()=>{const s=el('subcategoria').value; const st=el('setor'); st.innerHTML='<option value="">Selecione...</option>'; st.disabled=true; if(s&&listaSetores[s]){st.disabled=false;listaSetores[s].forEach(x=>st.innerHTML+=`<option value="${x}">${x}</option>`);}};
        function updateSel(){const s=el('categoria');const v=s.value;s.innerHTML='<option value="">Selecione...</option>';(listaSubs["_order"]||[]).forEach(c=>s.innerHTML+=`<option value="${c}">${c}</option>`);s.value=v;}
        window.salvarVip=async()=>{const n=el('vipNome').value,e=el('vipEmail').value,p=el('vipPalavra').value;if(!n||!p)return alert("Obrigat√≥rios");const d={nome:n,email:e,nasc:el('vipNasc').value,palavra:p};if(idVipEditando)await updateDoc(doc(db,"vips",idVipEditando),d);else await addDoc(collection(db,"vips"),d);alert("VIP Salvo!");cancelarEdicaoVip();};
        window.editVip=(id,n,d,e,p)=>{idVipEditando=id;el('vipNome').value=n;el('vipNasc').value=d;el('vipEmail').value=e;el('vipPalavra').value=p;el('btnSalvarVip').textContent="Atualizar VIP";el('btnCancelVip').style.display='inline';};
        window.cancelarEdicaoVip=()=>{idVipEditando=null;el('vipNome').value="";el('vipPalavra').value="";el('btnSalvarVip').textContent="Cadastrar VIP";el('btnCancelVip').style.display='none';};
        window.delVip=async(id)=>{if(confirm("Apagar?"))await deleteDoc(doc(db,"vips",id));};
        window.salvarConfigGlobal=async()=>{await setDoc(doc(db,"config","geral"),{titulo:el('confNomeCidade').value,zapAdmin:el('confZapAdmin').value,opacAzul:el('opacAzul').value,opacPreto:el('opacPreto').value,logoHeight:el('confLogoHeight').value,logoTop:el('confLogoTop').value},{merge:true});alert("Salvo");};
        window.salvarCidade=async()=>{await addDoc(collection(db,"cidades"),{nome:el('novaCidadeNome').value,uf:el('novaCidadeUF').value,login:el('novaCidadeLogin').value,senha:el('novaCidadeSenha').value});alert("Salva");};
        window.prepararEdicaoUsuario = (id, nome, email, senha, cidadeId) => { idUsuarioEditando = id; el('editUserName').value = nome; el('editUserEmail').value = email; el('editUserPass').value = senha; el('editUserCidade').value = cidadeId; el('formEditUser').style.display = 'block'; };
        window.cancelarEdicaoUsuario = () => { idUsuarioEditando = null; el('formEditUser').style.display = 'none'; };
        window.salvarEdicaoUsuario = async () => { if(!idUsuarioEditando) return; const nome = el('editUserName').value.trim(); const senha = el('editUserPass').value.trim(); const cidadeId = el('editUserCidade').value; await updateDoc(doc(db, "users", idUsuarioEditando), { nome, senha, cidadeId }); alert("Atualizado!"); cancelarEdicaoUsuario(); };
    </script>
</body>
</html>