<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Admin - Gest√£o</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>try{emailjs.init("vOaHzeApkyntx09x6");}catch(e){}</script>
    
    <style>
        /* ESTILOS BASE (MANTIDOS) */
        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; -webkit-user-select: none; user-select: none; }
        input, textarea, select { -webkit-user-select: text; user-select: text; }
        body { padding: 20px; background: #f0f2f5; max-width: 900px; margin: 0 auto; color: #333; padding-bottom: 80px; }

        /* LOGIN */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .login-box { text-align: center; background: #2c2c2c; padding: 40px; border-radius: 16px; width: 90%; max-width: 380px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #333; color: white; font-size: 16px; text-align: center; }
        .btn-login { background: #007bff; color: white; padding: 12px; width: 100%; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }

        /* HEADER */
        .header-admin { display: none; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .badge-role { background: #ffc107; color: #333; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 800; text-transform: uppercase; margin-left: 10px; }
        
        /* CARDS */
        .card { background: white; border-radius: 12px; margin-bottom: 15px; display: block; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; border-top: 4px solid #ccc; transition: all 0.3s ease; }
        
        #painelCidades { border-color: #ff5722; } 
        #painelUsuarios { border-color: #28a745; } /* VERDE PARA DESTAQUE */
        #painelVips { border-color: #ffc107; } 
        #painelCategorias { border-color: #17a2b8; } 
        #painelCadastro { border-color: #007bff; } 
        #painelLista { border-color: #6c757d; } 

        .card-header-area { padding: 20px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #fff; transition: background 0.2s; }
        .card-header-area:hover { background: #f9f9f9; }
        .card h2 { margin: 0; font-size: 18px; color: #444; display: flex; align-items: center; gap: 10px; pointer-events: none; }
        .toggle-icon { font-size: 18px; color: #888; transition: transform 0.3s; }
        .card-body { display: none; padding: 0 25px 25px 25px; border-top: 1px solid #eee; animation: fadeIn 0.3s; }
        .card.open .card-body { display: block; }
        .card.open .toggle-icon { transform: rotate(180deg); color: #333; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* FORMS E BOTOES */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; margin-top: 15px; }
        .form-full { width: 100%; margin-bottom: 15px; }
        label { font-weight: 600; font-size: 13px; color: #666; margin-bottom: 6px; display: block; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: #fff; }
        
        .btn { border: none; padding: 10px 15px; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; font-size: 13px; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: #007bff; } .btn-success { background: #28a745; } .btn-danger { background: #dc3545; } .btn-warning { background: #ffc107; color: #333; } .btn-info { background: #17a2b8; } 
        .btn-sm { padding: 5px 10px; font-size: 11px; border-radius: 6px; }
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }

        .manager-item { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 12px 15px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 8px; flex-wrap: wrap; gap: 10px; }
        
        /* ESTILO ESPEC√çFICO PARA LISTA DE USU√ÅRIOS */
        .user-block { display: flex; flex-direction: column; width: 100%; border-bottom: 1px solid #ddd; padding: 15px 0; }
        .user-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .user-name { font-size: 15px; font-weight: bold; color: #333; }
        .user-email { font-size: 12px; color: #666; }
        .user-loja-tag { margin-top: 5px; background: #e3f2fd; color: #0d47a1; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; display: inline-block; }
        .user-controls { display: flex; gap: 10px; margin-top: 10px; }
        .status-blocked { text-decoration: line-through; color: red; }
        
        .cat-block { border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; overflow: hidden; background: white; }
        .cat-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: #fff; cursor: pointer; }
        .sub-manager-container { display: none; background: #f4f6f8; padding: 10px; border-top: 1px solid #e0e0e0; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; align-items: center; }
        .menu-adder { display: flex; gap: 10px; align-items: center; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        
        /* MODAIS */
        .modal-icons { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .modal-icons-content { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 12px; text-align: center; }
        #inputCustomIcon { font-size: 40px; text-align: center; padding: 10px; width: 100%; margin-bottom: 20px; }
        
        /* GALERIA E PALPITES */
        .gallery-list-container { margin-top: 15px; display: flex; flex-direction: column; gap: 10px; }
        .gallery-item-admin { display: flex; align-items: flex-start; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .gallery-thumb-admin { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; margin-right: 15px; }
        .gallery-info-admin { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .palpite-row { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .palpite-winner { background: #d4edda !important; border-left: 5px solid #28a745; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <img src="logo.png" style="max-width:120px; margin-bottom:20px; cursor: pointer;" alt="Logo" onclick="window.location.href='index.html'">
            <h3 style="color:white; margin-bottom:20px;">Acesso Administrativo</h3>
            <input id="inputUsuario" class="login-input" placeholder="Usu√°rio">
            <input id="inputSenha" type="password" class="login-input" placeholder="Senha" onkeypress="if(event.key==='Enter') fazerLogin()">
            <button class="btn btn-primary" style="margin-top:20px; width:100%; font-size:16px;" onclick="fazerLogin()">ENTRAR</button>
        </div>
    </div>

    <div class="header-admin" id="headerAdmin">
        <div class="header-left">
            <h2 style="margin:0; font-size:20px;">Painel de Gest√£o <span id="roleBadge" class="badge-role">...</span></h2>
        </div>
        <div>
            <a href="index.html" class="btn btn-secondary btn-sm">üè† Ver App</a>
            <button onclick="logout()" class="btn btn-danger btn-sm" style="margin-left:10px;">üö™ Sair</button>
        </div>
    </div>

    <div class="card" id="painelCidades">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)">
            <h2>üèôÔ∏è Cidades (Estrutura)</h2><span class="toggle-icon">‚ñº</span>
        </div>
        <div class="card-body">
            <div id="listaCidades" style="margin-bottom:20px;">Carregando...</div>
            <div style="background:#f8f9fa; padding:15px; border-radius:8px;">
                <h3 style="font-size:15px; margin-top:0;">Cadastrar Nova Cidade</h3>
                <div class="form-grid"><div><label>Nome</label><input id="novaCidadeNome"></div><div><label>UF</label><input id="novaCidadeUF"></div></div>
                <div class="form-grid"><div><label>Login Admin</label><input id="novaCidadeLogin"></div><div><label>Senha Admin</label><input id="novaCidadeSenha"></div></div>
                <button class="btn btn-success" style="width:100%;" onclick="salvarCidade()">+ Adicionar Cidade</button>
            </div>
        </div>
    </div>

    <div class="card" id="painelUsuarios">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)">
            <h2>üë• Gerenciar Usu√°rios (Donos)</h2><span class="toggle-icon">‚ñº</span>
        </div>
        <div class="card-body">
            <p style="font-size:13px; color:#666; margin-bottom:15px; background:#fff3cd; padding:10px; border-radius:6px; border:1px solid #ffeeba;">
                Aqui voc√™ controla quem se cadastrou para ter um estabelecimento. <br>
                <b>Bloquear Acesso:</b> Impede o login. <br>
                <b>Ocultar Loja:</b> O estabelecimento some do App (Busca e Listas), mas n√£o √© apagado.
            </p>
            <div id="listaUsuarios">Carregando...</div>
        </div>
    </div>
    
    <div class="card" id="painelVips">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)">
            <h2>üíé Membros VIP</h2><span class="toggle-icon">‚ñº</span>
        </div>
        <div class="card-body">
            <div class="form-grid"><div><label>Nome</label><input id="vipNome"></div><div><label>WhatsApp</label><input type="number" id="vipPhone"></div></div>
            <div class="form-grid"><div><label>Email</label><input type="email" id="vipEmail"></div><div><label>Senha VIP</label><input type="text" id="vipPalavra"></div></div>
            <button id="btnSalvarVip" class="btn btn-success" style="width:100%;" onclick="salvarVip()">Cadastrar VIP</button>
            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;"><div id="listaVips"></div>
        </div>
    </div>

    <div class="card" id="painelPalpites">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)">
            <h2>üé≤ Palpites / Sorteios</h2><span class="toggle-icon">‚ñº</span>
        </div>
        <div class="card-body">
            <button class="btn btn-danger btn-sm" style="margin-bottom:15px;" onclick="limparPalpites()">üóëÔ∏è Limpar Lista</button>
            <div id="listaPalpites" style="border:1px solid #ddd; border-radius:8px; max-height:400px; overflow-y:auto;"></div>
        </div>
    </div>

    <div class="card" id="painelCategorias">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)">
            <h2>üìÇ Categorias e √çcones</h2><span class="toggle-icon">‚ñº</span>
        </div>
        <div class="card-body">
            <div id="listaGestaoCategorias"></div>
            <div style="margin-top:20px; display:flex; gap:10px;"><input id="novaCategoriaInput" placeholder="Nome da Nova Categoria" style="flex:1;"><button class="btn btn-success" onclick="adicionarCategoria()">+ Criar</button></div>
        </div>
    </div>
    
    <div class="card" id="painelMasterConfig">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)">
            <h2>‚öôÔ∏è Configura√ß√µes Gerais</h2><span class="toggle-icon">‚ñº</span>
        </div>
        <div class="card-body">
            <div class="form-grid"><div><label>Nome App</label><input type="text" id="confNomeCidade"></div><div><label>WhatsApp Admin</label><input type="number" id="confZapAdmin"></div></div>
            <button class="btn btn-primary" style="width:100%;" onclick="salvarConfigGlobal()">Salvar Configura√ß√µes</button>
        </div>
    </div>

    <div class="card" id="painelCadastro" style="display:block;">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)">
            <h2 id="tituloForm">üè™ Cadastrar / Editar Local</h2><span class="toggle-icon">‚ñº</span>
        </div>
        <div class="card-body">
            <div class="form-full" id="divSelCidade" style="display:none;"><label style="color:#ff5722;">Cidade</label><select id="selCidadeCadastro" style="border:1px solid #ff5722"></select></div>
            <div class="form-grid"><div><label>Categoria</label><select id="categoria"><option value="">Selecione...</option></select></div><div><label>Subcategoria</label><select id="subcategoria" disabled><option value="">...</option></select></div></div>
            <div class="form-full"><label>Setor (Opcional)</label><select id="setor" disabled><option value="">...</option></select></div>
            <div class="form-full"><label>Nome do Local</label><input id="nome"></div>
            <div class="form-full"><label>Descri√ß√£o Curta</label><input id="descricao" maxlength="60"></div>
            <div id="camposPadrao">
                <div class="form-grid"><div><label>Pre√ßo (Opcional)</label><input id="precoAtual"></div><div><label>Pre√ßo Antigo</label><input id="precoAntigo"></div></div>
                <div class="form-full"><label>Endere√ßo</label><input id="cidade"></div>
                <div class="form-grid"><div><label>Foto Capa (URL)</label><input id="imagem"></div><div><label>Link Maps</label><input id="linkMapa"></div></div>
                <div class="form-grid"><div><label>WhatsApp</label><input id="contato"></div><div><label>Instagram</label><input id="instagram"></div></div>
                <div class="checkbox-group">
                    <label style="color:#28a745; font-weight:bold;"><input type="checkbox" id="checkDelivery" onclick="verificarTermosDelivery(this)"> üõµ Delivery</label>
                    <label><input type="checkbox" id="checkPubli"> üì¢ Banner</label>
                    <label style="color:#ffc107; font-weight:bold;"><input type="checkbox" id="checkPartner"> ‚≠ê Parceiro</label>
                </div>
                <div id="boxInfoDelivery" style="display:none; margin-top:15px; border-top:1px solid #ddd; padding-top:10px;">
                    <h4>üìù Card√°pio Delivery</h4>
                    <div class="menu-adder"><input id="prodNome" placeholder="Item"><input id="prodPreco" placeholder="Pre√ßo" style="width:80px;"><button class="btn btn-info btn-sm" onclick="addItemMenu()">Add</button></div>
                    <div id="lista-cardapio-preview" style="margin-top:10px;"></div>
                    <label style="margin-top:10px; color:#28a745;">üéÅ Brinde do Sorteio</label>
                    <select id="deliveryBrinde"><option value="">Adicione itens primeiro...</option></select>
                </div>
                <div id="boxPubli" style="display:none; margin-top:10px;"><label>Imagem Banner</label><input id="imgPubli"></div>
            </div>
            <div id="boxGaleriaManager" style="display:none; background:#fff3e0; padding:15px; margin-bottom:15px;">
                <h4>üì∑ Fotos da Galeria</h4>
                <div class="form-grid"><div><input id="inputNovaFoto" placeholder="URL Foto"></div><button class="btn btn-warning" onclick="addFotoGaleria()">Add</button></div>
                <div id="previewGaleria" class="gallery-list-container"></div>
            </div>
            <div class="btn-row"><button id="btnSalvar" class="btn btn-success" onclick="salvarOuAtualizar()">Salvar Registro</button><button id="btnCancelar" class="btn btn-danger" style="display:none;" onclick="limparForm()">Cancelar</button></div>
        </div>
    </div>

    <div class="card" id="painelLista" style="display:block;">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)">
            <h3>üìã Lista de Cadastros</h3><span class="toggle-icon">‚ñº</span>
        </div>
        <div class="card-body">
            <div id="lista-locais"></div>
        </div>
    </div>

    <div id="modalTermos" class="modal-icons"><div class="modal-icons-content"><h3>Termos Delivery</h3><p>Taxa de manuten√ß√£o e 1 Brinde a cada ciclo.</p><button class="btn btn-success" onclick="aceitarTermos()">Concordo</button></div></div>
    <div id="modalIconPicker" class="modal-icons"><div class="modal-icons-content"><h3>√çcone</h3><input type="text" id="inputCustomIcon"><button class="btn btn-success" onclick="salvarIconeCustomizado()">Salvar</button></div></div>

    <script type="module">
        const VERSAO_ATUAL="11.0"; if(localStorage.getItem("v_adm")!==VERSAO_ATUAL){localStorage.setItem("v_adm",VERSAO_ATUAL);location.reload(true);}
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, getDoc, setDoc, onSnapshot, query, where, getDocs, orderBy, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const app=initializeApp({apiKey:"AIzaSyDsTWnP2cmsUIDeDlotoR1uELMAba_-dyw",authDomain:"testegithub-e1ffb.firebaseapp.com",projectId:"testegithub-e1ffb",storageBucket:"testegithub-e1ffb.firebasestorage.app",messagingSenderId:"508103458559",appId:"1:508103458559:web:55bc2fe4dc61d7b5ee16ca"}); const db=getFirestore(app); const el=id=>document.getElementById(id);
        let currentUser=null, listaSubs={}, listaSetores={}, customIcons={}, idEditando=null, catEditing=null, idVipEditando=null, cardapio=[], fotosGaleria=[], todosLocaisCache=[];

        window.toggleCard = (card) => { card.classList.toggle('open'); };

        window.fazerLogin=async()=>{
            const u=el('inputUsuario').value.trim(),p=el('inputSenha').value; 
            if(!u||!p) return alert("Preencha tudo"); 
            if(u==='admin'&&p==='admin123'){ currentUser={role:'master'};init();return; } 
            
            try{
                let q=query(collection(db,"users"),where("email","==",u),where("senha","==",p));
                let s=await getDocs(q);
                if(!s.empty){
                    const d = s.docs[0].data();
                    if (d.blockedAccess) { alert("Acesso Bloqueado pelo Admin."); return; } 
                    currentUser={role:'owner', userId: s.docs[0].id, cityId: d.cidadeId};
                    init(); return;
                }
                let q2=query(collection(db,"cidades"),where("login","==",u),where("senha","==",p));
                let s2=await getDocs(q2);
                if(!s2.empty){currentUser={role:'city',cityId:s2.docs[0].id};init();return;}
                alert("Dados incorretos");
            }catch(e){console.error(e);alert("Erro conex√£o");}
        };

        window.logout = () => { window.location.reload(); };

        function init(){
            el('loginScreen').style.display='none';el('headerAdmin').style.display='flex'; 
            const m=currentUser.role==='master'; const c=currentUser.role==='city'; const o=currentUser.role==='owner';
            
            el('painelCidades').style.display=m?'block':'none';
            el('painelMasterConfig').style.display=m?'block':'none';
            
            // AGORA O PAINEL DE USU√ÅRIOS √â VIS√çVEL PARA A CIDADE (c) E MASTER (m)
            el('painelUsuarios').style.display=(c||m)?'block':'none'; 
            
            el('painelPalpites').style.display=(c||o||m)?'block':'none';
            el('painelVips').style.display=(c||o||m)?'block':'none'; 
            el('painelCategorias').style.display='block';
            el('painelCadastro').style.display='block';
            el('painelLista').style.display='block'; 
            
            if(m) el('divSelCidade').style.display='block'; 
            loadData(); if(c||o) carregarPalpites();
        }
        
        async function loadData(){
            onSnapshot(collection(db,"cidades"),s=>{el('selCidadeCadastro').innerHTML='<option value="">Selecione a Cidade</option>'; el('listaCidades').innerHTML=""; s.forEach(d=>{el('selCidadeCadastro').innerHTML+=`<option value="${d.id}">${d.data().nome}</option>`; el('listaCidades').innerHTML+=`<div class="manager-item"><b>${d.data().nome}</b></div>`;});});
            
            onSnapshot(doc(db,"config","categorias"),s=>{listaSubs=s.exists()?s.data():{"_order":[]};renderCats();});
            onSnapshot(doc(db,"config","setores"),s=>{listaSetores=s.exists()?s.data():{};});
            onSnapshot(doc(db,"config","icons"),s=>{customIcons=s.exists()?s.data():{};renderCats();});
            onSnapshot(doc(db,"config","geral"),s=>{if(s.exists()){const d=s.data();el('confZapAdmin').value=d.zapAdmin||"";el('confNomeCidade').value=d.titulo||"";}});
            onSnapshot(collection(db,"vips"),s=>{el('listaVips').innerHTML="";s.forEach(d=>el('listaVips').innerHTML+=`<div class="manager-item"><div><b>${d.data().nome}</b> (${d.data().palavra})</div><div><button class="btn btn-warning btn-sm" onclick="editVip('${d.id}','${d.data().nome}','${d.data().nasc}','${d.data().email}','${d.data().palavra}','${d.data().whatsapp}')">‚úèÔ∏è</button><button class="btn btn-danger btn-sm" onclick="delVip('${d.id}')">X</button></div></div>`);});
            
            let q=query(collection(db,"guia_cidades")); 
            if(currentUser.role==='city' || currentUser.role==='owner') q=query(collection(db,"guia_cidades"),where("cidadeId","==",currentUser.cityId));
            
            onSnapshot(q,s=>{
                el('lista-locais').innerHTML="";
                todosLocaisCache = [];
                s.forEach(d=>{
                    const item=d.data(); 
                    todosLocaisCache.push({id: d.id, ...item});
                    // Filtro visual para o admin (se est√° oculto ou n√£o)
                    const statusText = item.adminHidden ? '<span style="color:red; font-weight:bold;">[OCULTO]</span>' : '';
                    el('lista-locais').innerHTML+=`<div class="manager-item"><div><b>${item.nome}</b> ${statusText}<br><small>${item.categoria}</small></div><div><button class="btn btn-warning btn-sm" onclick="editLocal('${d.id}')">‚úèÔ∏è</button><button class="btn btn-danger btn-sm" onclick="delLocal('${d.id}')">X</button></div></div>`;
                });
                if(currentUser.role !== 'owner') carregarUsuariosDaCidade();
            });

            if(currentUser.role !== 'owner') carregarUsuariosDaCidade();
        }

        // --- GEST√ÉO DE USU√ÅRIOS (NOVA L√ìGICA) ---
        function carregarUsuariosDaCidade() {
            let qUser = collection(db,"users");
            if (currentUser.role === 'city') qUser = query(collection(db, "users"), where("cidadeId", "==", currentUser.cityId));

            onSnapshot(qUser, (snap)=>{
                el('listaUsuarios').innerHTML="";
                snap.forEach(doc=>{
                    const u = doc.data();
                    
                    // Acha se esse usu√°rio tem estabelecimento
                    const localDoUser = todosLocaisCache.find(l => l.ownerId === doc.id);
                    const nomeLocal = localDoUser ? localDoUser.nome : '<span style="color:#999">Sem loja criada</span>';
                    const localId = localDoUser ? localDoUser.id : null;
                    const isHidden = localDoUser ? localDoUser.adminHidden : false;

                    // Bot√£o Bloquear Acesso
                    const btnBlockAccess = u.blockedAccess 
                        ? `<button class="btn btn-danger btn-sm" onclick="toggleUserAccess('${doc.id}', false)">Desbloquear Acesso</button>` 
                        : `<button class="btn btn-success btn-sm" onclick="toggleUserAccess('${doc.id}', true)">Bloquear Acesso</button>`;
                        
                    // Bot√£o Ocultar Loja (S√≥ aparece se tiver loja)
                    let btnHideShop = "";
                    if(localId) {
                        btnHideShop = isHidden
                            ? `<button class="btn btn-danger btn-sm" onclick="toggleShopVisibility('${localId}', false)">√ò Est√° Oculto (Publicar)</button>`
                            : `<button class="btn btn-info btn-sm" onclick="toggleShopVisibility('${localId}', true)">üëÅÔ∏è Ocultar Loja</button>`;
                    }

                    const styleBlocked = u.blockedAccess ? 'border-left: 5px solid red; background:#ffebee;' : '';

                    el('listaUsuarios').innerHTML+=`
                    <div class="user-block" style="${styleBlocked}">
                        <div class="user-header">
                            <div>
                                <div class="user-name ${u.blockedAccess ? 'status-blocked' : ''}">${u.nome}</div>
                                <div class="user-email">${u.email}</div>
                                <div class="user-loja-tag">üè† ${nomeLocal}</div>
                            </div>
                        </div>
                        <div class="user-controls">
                            ${btnBlockAccess}
                            ${btnHideShop}
                        </div>
                    </div>`;
                });
            });
        }

        window.toggleUserAccess = async (uid, status) => { await updateDoc(doc(db, "users", uid), { blockedAccess: status }); };
        // Nova fun√ß√£o: Altera o status da LOJA, n√£o do usu√°rio
        window.toggleShopVisibility = async (lid, status) => { await updateDoc(doc(db, "guia_cidades", lid), { adminHidden: status }); };

        // --- PALPITES ---
        function carregarPalpites() {
            if(!currentUser.cityId) return;
            const q = query(collection(db, "vip_palpites"), where("cidadeId", "==", currentUser.cityId));
            onSnapshot(q, (snap) => {
                const div = el('listaPalpites'); div.innerHTML = "";
                let palpites = []; snap.forEach(doc => palpites.push({ id: doc.id, ...doc.data() }));
                palpites.sort((a,b) => (b.data?.seconds || 0) - (a.data?.seconds || 0));
                palpites.forEach(d => {
                    const style = d.isWinner ? 'background:#d4edda; border-left:5px solid green;' : '';
                    div.innerHTML += `<div class="palpite-row" style="${style}" onclick="toggleVencedor('${d.id}', ${d.isWinner})"><span class="palpite-num">${d.numero}</span><span style="margin-left:10px;">${d.vipNome} quer <b>${d.brinde}</b></span>${d.isWinner?' üèÜ':''}</div>`;
                });
            });
        }
        window.toggleVencedor = async (id, s) => { if(confirm("Mudar status de vencedor?")) await updateDoc(doc(db, "vip_palpites", id), { isWinner: !s }); };
        window.limparPalpites = async () => { if(confirm("Limpar tudo?")) { const q = query(collection(db, "vip_palpites"), where("cidadeId", "==", currentUser.cityId)); const s = await getDocs(q); const b = writeBatch(db); s.forEach(d=>b.delete(d.ref)); await b.commit(); }};

        // --- GALERIA & UPLOAD ---
        window.addFotoGaleria = () => { fotosGaleria.push({ url: el('inputNovaFoto').value, legenda: "" }); el('inputNovaFoto').value=""; renderGaleriaPreview(); };
        window.removeFotoGaleria = (i) => { fotosGaleria.splice(i,1); renderGaleriaPreview(); };
        window.updateFotoGaleria = (i, f, v) => { fotosGaleria[i][f] = v; };
        function renderGaleriaPreview() { el('previewGaleria').innerHTML = fotosGaleria.map((x,i)=>`<div class="gallery-item-admin"><img src="${x.url||x}" class="gallery-thumb-admin"><input value="${x.legenda||''}" onchange="updateFotoGaleria(${i},'legenda',this.value)" placeholder="Legenda"><button onclick="removeFotoGaleria(${i})">X</button></div>`).join(''); }

        el('categoria').addEventListener('change', () => {
            const cat = el('categoria').value; const s=el('subcategoria'); s.innerHTML='<option value="">Selecione...</option>'; s.disabled=true; 
            if(cat && listaSubs[cat]){s.disabled=false;listaSubs[cat].forEach(x=>s.innerHTML+=`<option value="${x}">${x}</option>`);}
            if (cat === "Galeria de Fotos") { el('camposPadrao').style.display = 'none'; el('boxGaleriaManager').style.display = 'block'; } else { el('camposPadrao').style.display = 'block'; el('boxGaleriaManager').style.display = 'none'; }
        });

        window.salvarOuAtualizar=async()=>{
            const d={cidadeId: currentUser.role==='master'?el('selCidadeCadastro').value : currentUser.cityId, nome:el('nome').value, nomeBusca:el('nome').value.toLowerCase(), descricao: el('descricao').value, categoria:el('categoria').value, subcategoria:el('subcategoria').value, setor:el('setor').value, cidade:el('cidade').value, galeria_fotos: fotosGaleria, contato:el('contato').value, instagram:el('instagram').value, imagem: el('imagem').value, preco:parseFloat(el('precoAtual').value)||0, precoAntigo:parseFloat(el('precoAntigo').value)||0, isPartner:el('checkPartner').checked, temDelivery: el('checkDelivery').checked, deliveryBrinde:el('deliveryBrinde').value,cardapio: cardapio, publi:{ativa:el('checkPubli').checked, img:el('imgPubli').value}, linkMapa:el('linkMapa').value};
            if(currentUser.role==='owner') d.ownerId = currentUser.userId;
            if(idEditando) await updateDoc(doc(db,"guia_cidades",idEditando),d); else await addDoc(collection(db,"guia_cidades"),d);
            alert("Salvo!"); limparForm();
        };

        window.editLocal = async (id) => {
            const d = (await getDoc(doc(db, "guia_cidades", id))).data(); idEditando = id;
            el('tituloForm').textContent="‚úèÔ∏è Editando: "+d.nome; el('nome').value=d.nome; el('descricao').value=d.descricao||"";
            el('categoria').value=d.categoria; el('categoria').dispatchEvent(new Event('change'));
            setTimeout(()=>{el('subcategoria').value=d.subcategoria; el('subcategoria').dispatchEvent(new Event('change')); el('setor').value=d.setor;},500);
            if(d.categoria==="Galeria de Fotos") { fotosGaleria = d.galeria_fotos||[]; renderGaleriaPreview(); }
            else { el('imagem').value=d.imagem; el('contato').value=d.contato; el('instagram').value=d.instagram; el('precoAtual').value=d.preco; el('checkDelivery').checked=d.temDelivery; if(d.temDelivery) el('boxInfoDelivery').style.display='block'; cardapio=d.cardapio||[]; renderMenu(); }
            el('btnSalvar').innerText="Atualizar"; el('btnCancelar').style.display='inline'; el('painelCadastro').classList.add('open');
        };

        window.limparForm=()=>{ idEditando=null; el('tituloForm').textContent="üè™ Cadastrar"; el('nome').value=""; el('btnSalvar').innerText="Cadastrar"; el('btnCancelar').style.display='none'; cardapio=[]; renderMenu(); fotosGaleria=[]; renderGaleriaPreview(); };
        window.delLocal=async(id)=>{if(confirm("Apagar?"))await deleteDoc(doc(db,"guia_cidades",id));};
        
        window.addItemMenu = () => {cardapio.push({nome:el('prodNome').value, preco:el('prodPreco').value}); el('prodNome').value=""; renderMenu();};
        function renderMenu() {el('lista-cardapio-preview').innerHTML = cardapio.map((x,i)=>`<div>${x.nome} - ${x.preco} <button onclick="cardapio.splice(${i},1);renderMenu()">X</button></div>`).join(''); const s=el('deliveryBrinde'); s.innerHTML=""; cardapio.forEach(c=>s.innerHTML+=`<option>${c.nome}</option>`);}
        
        window.salvarVip=async()=>{
            await addDoc(collection(db,"vips"), { nome:el('vipNome').value, email:el('vipEmail').value, palavra:el('vipPalavra').value, whatsapp:el('vipPhone').value });
            alert("VIP Salvo"); el('vipNome').value=""; el('vipEmail').value=""; el('vipPalavra').value=""; el('vipPhone').value="";
        };
        window.editVip=(id,n,da,e,p,ph)=>{el('vipNome').value=n; el('vipEmail').value=e; el('vipPalavra').value=p; el('vipPhone').value=ph; idVipEditando=id;};
        window.delVip=async(id)=>{if(confirm("Apagar?"))await deleteDoc(doc(db,"vips",id));};

        function renderCats(){const d=el('listaGestaoCategorias');d.innerHTML="";(listaSubs["_order"]||[]).forEach(c=>{let ic=customIcons[c]||"üìÇ";d.innerHTML+=`<div class="cat-block"><div class="cat-header"><div style="font-weight:bold;">${ic} ${c}</div><div><button class="btn btn-info btn-sm" onclick="openIcon('${c}')">Icon</button><button class="btn btn-warning btn-sm" onclick="editCat('${c}')">‚úèÔ∏è</button><button class="btn btn-secondary btn-sm" onclick="toggleSubs('${c}')">Subs</button><button class="btn btn-danger btn-sm" onclick="delCat('${c}')">X</button></div></div><div id="subs-${c}" class="sub-manager-container">${(listaSubs[c]||[]).map((s,i)=>`<div class="sub-item"><div>${s}</div><div><button class="btn btn-secondary btn-sm" style="padding:2px;" onclick="toggleSetores('${s}')">Set</button><button class="btn btn-danger btn-sm" style="padding:2px;" onclick="delSub('${c}',${i})">X</button></div></div><div id="setores-${s}" class="sector-manager-container">${(listaSetores[s]||[]).map((st,sti)=>`<div class="sector-item"><span>${st}</span> <button class="btn btn-danger btn-sm" style="padding:0;" onclick="delSetor('${s}',${sti})">x</button></div>`).join('')}<div style="display:flex; margin-top:5px;"><input id="new-setor-${s}" class="input-inline"><button class="btn btn-success btn-sm" onclick="addSetor('${s}')">+</button></div></div>`).join('')}<div style="display:flex; margin-top:10px;"><input id="new-sub-${c}" style="flex:1;"><button class="btn btn-success btn-sm" onclick="addSub('${c}')">+ Add</button></div></div></div>`;});}
        window.openIcon=c=>{catEditing=c;el('modalIconPicker').style.display='flex';el('inputCustomIcon').value=customIcons[c]||"";};
        window.salvarIconeCustomizado=async()=>{const v=el('inputCustomIcon').value.trim();if(v)customIcons[catEditing]=v;else delete customIcons[catEditing];await setDoc(doc(db,"config","icons"),customIcons);el('modalIconPicker').style.display='none';};
        window.adicionarCategoria=async()=>{const n=el('novaCategoriaInput').value.trim();if(!n)return;if(!listaSubs["_order"])listaSubs["_order"]=[];listaSubs["_order"].push(n);await setDoc(doc(db,"config","categorias"),listaSubs);renderCats();el('novaCategoriaInput').value="";};
        window.delCat=async(n)=>{if(confirm("Apagar?")){listaSubs["_order"]=listaSubs["_order"].filter(x=>x!==n);delete listaSubs[n];await setDoc(doc(db,"config","categorias"),listaSubs);renderCats();}};
        window.toggleSubs=id=>{const x=document.getElementById('subs-'+id);x.style.display=x.style.display==='block'?'none':'block';};
        window.toggleSetores=id=>{const x=document.getElementById('setores-'+id);x.style.display=x.style.display==='block'?'none':'block';};
        window.addSub=async(c)=>{const v=document.getElementById('new-sub-'+c).value.trim();if(!v)return;if(!listaSubs[c])listaSubs[c]=[];listaSubs[c].push(v);await setDoc(doc(db,"config","categorias"),listaSubs);renderCats();};
        window.delSub=async(c,i)=>{if(confirm("Apagar?")){listaSubs[c].splice(i,1);await setDoc(doc(db,"config","categorias"),listaSubs);renderCats();}};
        window.addSetor=async(s)=>{const v=document.getElementById('new-setor-'+s).value.trim();if(!v)return;if(!listaSetores[s])listaSetores[s]=[];listaSetores[s].push(v);await setDoc(doc(db,"config","setores"),listaSetores);renderCats();};
        window.delSetor=async(s,i)=>{if(confirm("Apagar?")){listaSetores[s].splice(i,1);await setDoc(doc(db,"config","setores"),listaSetores);renderCats();}};
        el('subcategoria').onchange=()=>{const s=el('subcategoria').value; const st=el('setor'); st.innerHTML='<option value="">Selecione...</option>'; st.disabled=true; if(s&&listaSetores[s]){st.disabled=false;listaSetores[s].forEach(x=>st.innerHTML+=`<option value="${x}">${x}</option>`);}};
        
        window.verificarTermosDelivery=(c)=>{if(c.checked){el('modalTermos').style.display='flex'; c.checked=false;}else el('boxInfoDelivery').style.display='none';};
        window.aceitarTermos=()=>{el('checkDelivery').checked=true;el('boxInfoDelivery').style.display='block';el('modalTermos').style.display='none';};
        window.salvarConfigGlobal=async()=>{await setDoc(doc(db,"config","geral"),{titulo:el('confNomeCidade').value,zapAdmin:el('confZapAdmin').value},{merge:true});alert("Salvo");};
        window.salvarCidade=async()=>{await addDoc(collection(db,"cidades"),{nome:el('novaCidadeNome').value,uf:el('novaCidadeUF').value,login:el('novaCidadeLogin').value,senha:el('novaCidadeSenha').value});alert("Salvo");};
    </script>
</body>
</html>