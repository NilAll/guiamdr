<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Admin - Gest√£o</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>try{emailjs.init("vOaHzeApkyntx09x6");}catch(e){}</script>
    
    <style>
        /* ESTILOS GERAIS */
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { padding: 20px; background: #f0f2f5; max-width: 900px; margin: 0 auto; color: #333; padding-bottom: 80px; }
        
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-size: 14px; }
        label { font-weight: 600; font-size: 12px; color: #555; display: block; margin-bottom: 4px; }
        
        .btn { padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; color: white; font-weight: bold; font-size: 14px; }
        .btn-primary { background: #007bff; } .btn-success { background: #28a745; } .btn-danger { background: #dc3545; } .btn-warning { background: #ffc107; color: #333; }
        .btn-sm { padding: 5px 10px; font-size: 12px; margin-left: 5px; }
        
        /* HEADER */
        .header-admin { display: none; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* LOGIN */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .login-box { text-align: center; background: #2c2c2c; padding: 40px; border-radius: 16px; width: 90%; max-width: 320px; }
        
        /* CARDS */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 4px solid #ccc; display: none; }
        .card-header-area { display: flex; justify-content: space-between; cursor: pointer; align-items: center; }
        .card h2 { margin: 0; font-size: 18px; }
        .card-body { display: none; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        .card.open .card-body { display: block; }
        
        .manager-item, .plan-item { background: #f8f9fa; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        
        /* PREVIEW IMAGEM */
        .preview-box { width: 100%; height: 100px; background: #eee; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; border-radius: 8px; overflow: hidden; }
        .preview-box img { max-width: 100%; max-height: 100%; }

        /* USER BLOCK */
        .user-block { display: flex; flex-direction: column; width: 100%; border-bottom: 1px solid #ddd; padding: 10px 0; }
        .user-header { display: flex; justify-content: space-between; }
        .user-controls { margin-top: 5px; display: flex; gap: 5px; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <img src="logo.png" style="height:60px; margin-bottom:20px; cursor: pointer;" onclick="window.location.href='index.html'" onerror="this.style.display='none'">
            <h3>Acesso Restrito</h3>
            <input id="inputUsuario" placeholder="Usu√°rio" style="text-align:center">
            <input id="inputSenha" type="password" placeholder="Senha" style="text-align:center" onkeypress="if(event.key==='Enter') fazerLogin()">
            <button class="btn btn-primary" style="width:100%" onclick="fazerLogin()">ENTRAR</button>
        </div>
    </div>

    <div class="header-admin" id="headerAdmin">
        <div>
            <h2 style="margin:0; font-size:20px;">Painel de Gest√£o</h2>
            <div id="userDisplay" style="color:#007bff; font-size:13px; font-weight:bold; margin-top:5px;"></div>
        </div>
        <div>
            <a href="index.html" class="btn btn-primary btn-sm">üè† Ver App</a> 
            <button onclick="logout()" class="btn btn-danger btn-sm">Sair</button>
        </div>
    </div>

    <div class="card" id="painelCidades" style="border-color:#ff5722;">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)"><h2>üèôÔ∏è Cidades e Admins</h2><span>‚ñº</span></div>
        <div class="card-body">
            <div id="listaCidades"></div>
            <hr>
            <h3>Nova Cidade + Admin</h3>
            <input id="novaCidadeNome" placeholder="Nome Cidade"><input id="novaCidadeUF" placeholder="UF">
            <input id="novaCidadeFundo" placeholder="Img Fundo Padr√£o (URL)">
            
            <h4 style="font-size:14px; margin-top:15px;">Dados do Admin Local</h4>
            <input id="adminNome" placeholder="Nome Completo"><input id="adminEmailContato" placeholder="Email"><input id="adminZap" placeholder="WhatsApp">
            <input id="adminCPF" placeholder="CPF"><input id="adminEnd" placeholder="Endere√ßo">
            <div style="background:#eef; padding:10px; border-radius:8px; margin-top:10px;">
                <input id="novaCidadeLogin" placeholder="Login Acesso"><input id="novaCidadeSenha" placeholder="Senha Acesso">
            </div>
            <button class="btn btn-success" style="width:100%; margin-top:10px;" onclick="salvarCidade()">Salvar Cidade</button>
        </div>
    </div>

    <div class="card" id="painelPlanos" style="border-color:#6610f2;">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)"><h2>üí∞ Gerenciar Planos</h2><span>‚ñº</span></div>
        <div class="card-body">
            <h3 id="tituloPlanos" style="margin-top:0; color:#6610f2;">Adicionar / Editar Plano</h3>
            
            <div style="display:flex; gap:10px">
                <div style="flex:1"><label>Tipo</label><select id="planoTipo"><option value="assinatura">Assinatura</option><option value="franquia">Franquia</option></select></div>
                <div style="flex:1"><label>Destaque</label><select id="planoCor"><option value="white">Normal</option><option value="blue">Destaque (Azul)</option></select></div>
            </div>
            
            <label>Nome do Plano</label>
            <input id="planoNome" placeholder="Ex: Master">
            
            <div style="background:#f8f9fa; padding:10px; border-radius:8px; border:1px solid #ddd; margin-bottom:10px;">
                <h4 style="margin:0 0 10px 0;">Pre√ßos (Use ponto para centavos. 0 = Gr√°tis)</h4>
                <div style="display:flex; gap:10px">
                    <div style="flex:1"><label>Mensal (R$)</label><input id="planoPrecoMensal" type="number" placeholder="0.00"></div>
                    <div style="flex:1"><label>Semestral (Total)</label><input id="planoPrecoSemestral" type="number" placeholder="0.00"></div>
                    <div style="flex:1"><label>Anual (Total)</label><input id="planoPrecoAnual" type="number" placeholder="0.00"></div>
                </div>
            </div>

            <label>Itens do Plano (Separe por ponto e v√≠rgula ; )</label>
            <textarea id="planoItens" placeholder="Fotos; Mapa; Link Zap..." style="height:80px"></textarea>
            
            <div style="display:flex; gap:10px;">
                <button id="btnSalvarPlano" class="btn btn-success" style="flex:1" onclick="salvarPlano()">Salvar Plano</button>
                <button id="btnCancelarPlano" class="btn btn-danger" style="flex:1; display:none;" onclick="cancelarEdicaoPlano()">Cancelar</button>
            </div>
            
            <hr>
            <h3>Planos Ativos</h3>
            <div id="listaPlanosCadastrados"></div>
        </div>
    </div>

    <div class="card" id="painelConfigCidade" style="border-color:#e91e63;">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)"><h2>üé® Apar√™ncia da Cidade</h2><span>‚ñº</span></div>
        <div class="card-body">
            <input id="inputCidadeFundo" placeholder="URL Fundo Oficial" onchange="el('prevFundo').src=this.value">
            <div class="preview-box"><img id="prevFundo" alt="Fundo"></div>
            <input id="inputCidadeLogo" placeholder="URL Logo Topo" onchange="el('prevLogo').src=this.value">
            <div class="preview-box"><img id="prevLogo" alt="Logo"></div>
            <button class="btn btn-primary" onclick="salvarConfiguracaoCidade()">Salvar Apar√™ncia</button>
        </div>
    </div>

    <div class="card" id="painelUsuarios" style="border-color:#28a745;">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)"><h2>üë• Estabelecimentos</h2><span>‚ñº</span></div>
        <div class="card-body">
            <input id="buscaUsuarioInput" placeholder="üîç Buscar por nome..." onkeyup="filtrarUsuarios()">
            <div id="listaUsuarios"></div>
        </div>
    </div>

    <div class="card" id="painelCadastro" style="border-color:#007bff;">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)"><h2>üè™ Cadastrar / Editar</h2><span>‚ñº</span></div>
        <div class="card-body">
            <h3 id="tituloForm">Novo Cadastro</h3>
            <input id="nome" placeholder="Nome do Local">
            <input id="descricao" placeholder="Descri√ß√£o Curta">
            <div style="display:flex; gap:10px;">
                <select id="categoria" onchange="changeCat()"></select>
                <select id="subcategoria"></select>
            </div>
            <select id="setor" disabled><option>Setor...</option></select>
            <input id="imagem" placeholder="URL Foto Capa">
            <input id="cidade" placeholder="Endere√ßo Completo">
            
            <div id="camposPadrao">
                <input id="contato" placeholder="WhatsApp"><input id="instagram" placeholder="Instagram"><input id="linkMapa" placeholder="Link Maps">
                <div style="display:flex; gap:10px;"><input id="precoAtual" placeholder="Pre√ßo"><input id="precoAntigo" placeholder="Pre√ßo Antigo"></div>
                <div style="background:#eee; padding:10px; border-radius:8px;">
                    <label><input type="checkbox" id="checkDelivery" onclick="if(this.checked){el('boxInfoDelivery').style.display='block'}else{el('boxInfoDelivery').style.display='none'}"> üõµ Delivery</label>
                    <label style="margin-left:10px"><input type="checkbox" id="checkPubli"> üì¢ Banner</label>
                    <label style="margin-left:10px"><input type="checkbox" id="checkPartner"> ‚≠ê Parceiro</label>
                    <div id="boxInfoDelivery" style="display:none; margin-top:10px; border-top:1px solid #ccc; padding-top:10px;">
                        <input id="prodNome" placeholder="Item" style="width:60%"><input id="prodPreco" placeholder="Pre√ßo" style="width:30%"><button class="btn btn-info btn-sm" onclick="addItemMenu()">Ok</button>
                        <div id="lista-cardapio-preview"></div>
                        <label>Brinde:</label> <select id="deliveryBrinde"></select>
                    </div>
                    <div id="boxPubli" style="display:none; margin-top:10px;"><input id="imgPubli" placeholder="URL Banner"></div>
                </div>
            </div>

            <div id="boxGaleriaManager" style="display:none; background:#fff3cd; padding:10px; margin-bottom:10px;">
                <h4>Galeria</h4>
                <input id="inputNovaFoto" placeholder="URL Foto"><button class="btn btn-warning btn-sm" onclick="addFotoGaleria()">Add</button>
                <div id="previewGaleria"></div>
            </div>

            <button class="btn btn-success" id="btnSalvar" style="width:100%" onclick="salvarOuAtualizar()">Salvar</button>
            <button class="btn btn-danger" id="btnCancelar" style="width:100%; margin-top:10px; display:none;" onclick="limparForm()">Cancelar</button>
            
            <select id="selCidadeCadastro" style="display:none"></select>
        </div>
    </div>

    <div class="card" id="painelLista" style="border-color:#6c757d;">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)"><h2>üìã Lista de Cadastros</h2><span>‚ñº</span></div>
        <div class="card-body"><div id="lista-locais"></div></div>
    </div>

    <div class="card" id="painelVips" style="border-color:#ffc107; display:none;">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)"><h2>üíé VIPs</h2><span>‚ñº</span></div>
        <div class="card-body">
            <input id="vipNome" placeholder="Nome"><input id="vipPhone" placeholder="Zap"><input id="vipEmail" placeholder="Email"><input id="vipPalavra" placeholder="Senha">
            <button class="btn btn-success" style="width:100%" onclick="salvarVip()">Salvar VIP</button>
            <div id="listaVips" style="margin-top:10px"></div>
        </div>
    </div>

    <div class="card" id="painelPalpites" style="display:none">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)"><h2>üé≤ Sorteios</h2><span>‚ñº</span></div>
        <div class="card-body"><button class="btn btn-danger" onclick="limparPalpites()">Limpar</button><div id="listaPalpites"></div></div>
    </div>

    <div class="card" id="painelCategorias">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)"><h2>üìÇ Categorias</h2><span>‚ñº</span></div>
        <div class="card-body">
            <div id="listaGestaoCategorias"></div>
            <input id="novaCategoriaInput" placeholder="Nova Categoria"><button class="btn btn-success" onclick="adicionarCategoria()">Criar</button>
        </div>
    </div>
    
    <div class="card" id="painelMasterConfig" style="display:none">
        <div class="card-header-area" onclick="toggleCard(this.parentElement)"><h2>‚öôÔ∏è Config</h2><span>‚ñº</span></div>
        <div class="card-body">
            <input id="confNomeCidade" placeholder="Nome App"><input id="confZapAdmin" placeholder="Zap Master">
            <button class="btn btn-primary" onclick="salvarConfigGlobal()">Salvar</button>
        </div>
    </div>

    <div id="modalIconPicker" class="modal-icons" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;align-items:center;justify-content:center;">
        <div class="modal-icons-content" style="background:white;padding:20px;border-radius:10px;text-align:center;">
            <h3>√çcone</h3><input type="text" id="inputCustomIcon" style="font-size:30px;text-align:center;width:50px;">
            <button class="btn btn-success" onclick="salvarIconeCustomizado()">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, query, where, onSnapshot, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const app = initializeApp({apiKey:"AIzaSyDsTWnP2cmsUIDeDlotoR1uELMAba_-dyw",authDomain:"testegithub-e1ffb.firebaseapp.com",projectId:"testegithub-e1ffb",storageBucket:"testegithub-e1ffb.firebasestorage.app",messagingSenderId:"508103458559",appId:"1:508103458559:web:55bc2fe4dc61d7b5ee16ca"}); 
        const db = getFirestore(app); const el = id => document.getElementById(id);
        let currentUser=null, planosCache=[], listaSubs={}, listaSetores={}, customIcons={}, idEditando=null, idCidadeEditando=null, indexPlanoEditando=null, catEditing=null, idVipEditando=null, cardapio=[], fotosGaleria=[], todosLocaisCache=[], usuariosCache=[], cidadesCache=[];

        window.toggleCard = c => c.classList.toggle('open');
        window.fazerLogin = async () => {
            const u=el('inputUsuario').value.trim(), p=el('inputSenha').value.trim();
            if(!u || !p) return alert("Preencha tudo");
            if(u==='admin' && p==='admin123') { currentUser={role:'master', nome:'Master', patente:'MASTER'}; init(); return; }
            try {
                let q = query(collection(db,'cidades'), where('login','==',u), where('senha','==',p));
                let s = await getDocs(q);
                if(!s.empty) { const d = s.docs[0].data(); currentUser={role:'city', cityId:s.docs[0].id, nome: d.adminNome || d.nome, patente:'ADMIN CIDADE'}; init(); return; }
                let q2 = query(collection(db,'users'), where('email','==',u), where('senha','==',p));
                let s2 = await getDocs(q2);
                if(!s2.empty) { const d = s2.docs[0].data(); if(d.blockedAccess) return alert("Acesso bloqueado."); currentUser={role:'owner', userId:s2.docs[0].id, cityId:d.cidadeId, nome: d.nome, patente:'PARCEIRO'}; init(); return; }
                alert("Dados inv√°lidos");
            } catch(e) { console.error(e); alert("Erro de conex√£o"); }
        };
        window.logout = () => location.reload();

        function init() {
            el('loginScreen').style.display='none'; el('headerAdmin').style.display='flex';
            el('userDisplay').innerText = `Logado: ${currentUser.nome} (${currentUser.patente})`;

            if(currentUser.role === 'master') { 
                el('painelCidades').style.display='block'; 
                el('painelPlanos').style.display='block'; 
                el('painelMasterConfig').style.display='block'; 
            }
            if(currentUser.role === 'city') { el('painelUsuarios').style.display='block'; el('painelCadastro').style.display='block'; el('painelConfigCidade').style.display='block'; }
            if(currentUser.role === 'owner') { el('painelCadastro').style.display='block'; }
            if(currentUser.role !== 'master') { el('painelLista').style.display='block'; el('painelVips').style.display='block'; el('painelPalpites').style.display='block'; }
            el('painelCategorias').style.display='block';
            loadData(); if(currentUser.role!=='master') carregarPalpites();
        }
        
        async function loadData() {
            onSnapshot(doc(db,'config','categorias'), s=>{ listaSubs=s.data()||{}; renderCats(); });
            onSnapshot(doc(db,'config','setores'), s=>{ listaSetores=s.data()||{}; });
            onSnapshot(doc(db,'config','icons'), s=>{ customIcons=s.data()||{}; renderCats(); });
            onSnapshot(doc(db,'config','geral'), s=>{ if(s.exists()){ const d=s.data(); el('confZapAdmin').value=d.zapAdmin||""; el('confNomeCidade').value=d.titulo||""; }});

            if(currentUser.role==='master') {
                onSnapshot(collection(db,'cidades'), s=>{
                    el('listaCidades').innerHTML = s.docs.map(d=>`<div class="manager-item"><div><b>${d.data().nome}</b><br><small>${d.data().adminNome||''}</small></div><button class="btn btn-warning btn-sm" onclick='editCidade("${d.id}")'>Editar</button></div>`).join('');
                    cidadesCache = s.docs.map(d=>({id:d.id,...d.data()}));
                });
                
                // CARREGAR E CRIAR PLANOS DE EXEMPLO AUTOMATICAMENTE (INCLUINDO MASTER)
                onSnapshot(doc(db,'config','planos'), s=>{
                    if(s.exists() && s.data().lista && s.data().lista.length>0) {
                        planosCache = s.data().lista;
                    } else {
                        // CRIA DADOS FICT√çCIOS NO BANCO SE ESTIVER VAZIO
                        planosCache = [
                            {tipo:'assinatura', nome:'B√°sico', mensal:0, semestral:0, anual:0, destaque:false, itens:['Nome e Telefone','Link WhatsApp']},
                            {tipo:'assinatura', nome:'Premium', mensal:29.90, semestral:149.90, anual:289.90, destaque:false, itens:['Fotos','Redes Sociais','Destaque']},
                            {tipo:'assinatura', nome:'Master', mensal:59.90, semestral:299.90, anual:550.00, destaque:true, itens:['Topo da Lista','Banner','Selo VIP', 'Notifica√ß√£o Push']}, // NOVO PLANO MASTER ADICIONADO
                            {tipo:'franquia', nome:'Cidade Peq.', mensal:299.00, semestral:1500.00, anual:2800.00, destaque:false, itens:['At√© 50k hab.','Exclusividade']},
                            {tipo:'franquia', nome:'Cidade M√©d.', mensal:499.00, semestral:2500.00, anual:4800.00, destaque:true, itens:['At√© 100k hab.','Suporte 24h']},
                            {tipo:'franquia', nome:'Capital', mensal:899.00, semestral:4500.00, anual:8500.00, destaque:false, itens:['Sem limite','Consultoria']}
                        ];
                        setDoc(doc(db,'config','planos'), {lista: planosCache});
                    }
                    renderPlanos();
                });
            }
            
            if(currentUser.role !== 'master') {
                let q = query(collection(db,'guia_cidades'), where('cidadeId','==',currentUser.cityId));
                if(currentUser.role==='owner') q = query(collection(db,'guia_cidades'), where('ownerId','==',currentUser.userId));
                onSnapshot(q, s=>{
                    todosLocaisCache = []; el('lista-locais').innerHTML="";
                    s.forEach(d=>{
                        const item=d.data(); todosLocaisCache.push({id:d.id, ...item});
                        let img = item.imagem || "https://via.placeholder.com/50";
                        if(item.categoria==="Galeria de Fotos" && item.galeria_fotos?.length>0) img = typeof item.galeria_fotos[0]==='string' ? item.galeria_fotos[0] : item.galeria_fotos[0].url;
                        el('lista-locais').innerHTML+=`<div class="manager-item"><div style="display:flex;align-items:center;gap:10px"><img src="${img}" style="width:50px;height:50px;object-fit:cover;border-radius:5px"><div><b>${item.nome}</b><br><small>${item.categoria}</small></div></div><button class="btn btn-warning btn-sm" onclick="editLocal('${d.id}')">Editar</button></div>`;
                    });
                    if(currentUser.role==='city') carregarCacheUsuarios();
                });
                if(currentUser.role==='city') {
                    const c = await getDoc(doc(db,'cidades',currentUser.cityId));
                    if(c.exists()) { el('inputCidadeFundo').value=c.data().fundo||""; el('inputCidadeLogo').value=c.data().logoPatra||""; el('prevFundo').src=c.data().fundo||""; el('prevLogo').src=c.data().logoPatra||""; }
                }
            }
        }
        
        // --- FUN√á√ïES DE PLANOS ---
        window.salvarPlano = async () => {
            const novo = { 
                tipo: el('planoTipo').value, 
                nome: el('planoNome').value, 
                destaque: el('planoCor').value==='blue', 
                itens: el('planoItens').value.split(';').map(x=>x.trim()).filter(x=>x),
                mensal: parseFloat(el('planoPrecoMensal').value) || 0,
                semestral: parseFloat(el('planoPrecoSemestral').value) || 0,
                anual: parseFloat(el('planoPrecoAnual').value) || 0
            };

            if(!novo.nome) return alert("Preencha o nome do plano.");

            if(indexPlanoEditando !== null) {
                planosCache[indexPlanoEditando] = novo;
                alert("Plano Atualizado!");
            } else {
                planosCache.push(novo); 
                alert("Plano Adicionado!");
            }

            await setDoc(doc(db,'config','planos'), {lista: planosCache}); 
            cancelarEdicaoPlano();
        };

        window.editarPlano = (index) => {
            const p = planosCache[index];
            indexPlanoEditando = index;
            el('tituloPlanos').innerText = "‚úèÔ∏è Editando Plano: " + p.nome;
            el('btnSalvarPlano').innerText = "Atualizar Plano";
            el('btnCancelarPlano').style.display = "block";
            
            el('planoTipo').value = p.tipo;
            el('planoNome').value = p.nome;
            el('planoCor').value = p.destaque ? 'blue' : 'white';
            el('planoPrecoMensal').value = p.mensal;
            el('planoPrecoSemestral').value = p.semestral;
            el('planoPrecoAnual').value = p.anual;
            el('planoItens').value = p.itens.join('; ');
            
            el('painelPlanos').scrollIntoView();
        };

        window.cancelarEdicaoPlano = () => {
            indexPlanoEditando = null;
            el('tituloPlanos').innerText = "Adicionar / Editar Plano";
            el('btnSalvarPlano').innerText = "+ Salvar Plano";
            el('btnCancelarPlano').style.display = "none";
            el('planoNome').value=""; el('planoItens').value=""; 
            el('planoPrecoMensal').value=""; el('planoPrecoSemestral').value=""; el('planoPrecoAnual').value="";
        };

        window.removerPlano = async (i) => { if(confirm("Apagar?")) { planosCache.splice(i,1); await setDoc(doc(db,'config','planos'), {lista:planosCache}); } };
        function renderPlanos() { 
            el('listaPlanosCadastrados').innerHTML = planosCache.map((p,i) => `
                <div class="plan-item" style="${p.destaque?'border-left:5px solid blue':''}">
                    <div>
                        <b>${p.nome}</b> (${p.tipo})<br>
                        <small>Mensal: R$${p.mensal} | Sem: R$${p.semestral} | Anual: R$${p.anual}</small>
                    </div>
                    <div>
                        <button class="btn btn-warning btn-sm" onclick="editarPlano(${i})">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="removerPlano(${i})">X</button>
                    </div>
                </div>`).join(''); 
        }

        // --- CIDADES ---
        window.editCidade = (id) => {
            const data = cidadesCache.find(c => c.id === id); idCidadeEditando = id;
            el('tituloCidadeForm').innerText = "‚úèÔ∏è Editando: " + data.nome;
            el('novaCidadeNome').value = data.nome||""; el('novaCidadeUF').value = data.uf||""; el('novaCidadeLogin').value = data.login||""; el('novaCidadeSenha').value = data.senha||""; el('novaCidadeFundo').value = data.fundo||""; el('adminNome').value = data.adminNome||""; el('adminCPF').value = data.adminCPF||""; el('adminZap').value = data.adminZap||""; el('adminEmailContato').value = data.adminEmail||""; el('adminEnd').value = data.adminEnd||"";
            el('painelCidades').scrollIntoView();
        };
        window.salvarCidade=async()=>{
            const d = { nome:el('novaCidadeNome').value, uf:el('novaCidadeUF').value, login:el('novaCidadeLogin').value, senha:el('novaCidadeSenha').value, fundo:el('novaCidadeFundo').value, adminNome:el('adminNome').value, adminCPF:el('adminCPF').value, adminZap:el('adminZap').value, adminEmail:el('adminEmailContato').value, adminEnd:el('adminEnd').value };
            if(idCidadeEditando) await updateDoc(doc(db,"cidades",idCidadeEditando), d); else await addDoc(collection(db,"cidades"), d);
            alert("Salvo!"); idCidadeEditando=null; el('tituloCidadeForm').innerText="Nova Cidade"; el('novaCidadeNome').value=""; el('novaCidadeLogin').value="";
        };

        // --- CADASTRO GERAL ---
        window.salvarOuAtualizar = async () => {
            try {
                let targetCityId = currentUser.cityId;
                if(currentUser.role === 'master') targetCityId = el('selCidadeCadastro').value;
                const d = { cidadeId: targetCityId, nome: el('nome').value, nomeBusca: el('nome').value.toLowerCase(), descricao: el('descricao').value, categoria: el('categoria').value, subcategoria: el('subcategoria').value, setor: el('setor').value, cidade: el('cidade').value, galeria_fotos: fotosGaleria, contato: el('contato').value, instagram: el('instagram').value, imagem: el('imagem').value, preco: parseFloat(el('precoAtual').value)||0, precoAntigo: parseFloat(el('precoAntigo').value)||0, isPartner: el('checkPartner').checked, temDelivery: el('checkDelivery').checked, deliveryBrinde: el('deliveryBrinde').value, cardapio: cardapio, publi: { ativa: el('checkPubli').checked, img: el('imgPubli').value }, linkMapa: el('linkMapa').value };
                if(currentUser.role === 'owner') d.ownerId = currentUser.userId;
                if(idEditando) await updateDoc(doc(db,"guia_cidades",idEditando), d); else await addDoc(collection(db,"guia_cidades"), d);
                alert("Salvo!"); limparForm();
            } catch(e) { alert("Erro ao salvar: "+e.message); }
        };
        window.editLocal = (id) => {
            const d = todosLocaisCache.find(x => x.id === id); idEditando = id; el('tituloForm').innerText="Editando: "+d.nome;
            el('nome').value=d.nome; el('descricao').value=d.descricao; el('cidade').value=d.cidade; el('categoria').value=d.categoria; changeCat(); el('subcategoria').value=d.subcategoria; el('imagem').value=d.imagem||"";
            if(d.categoria==="Galeria de Fotos") fotosGaleria = d.galeria_fotos||[]; else { cardapio=d.cardapio||[]; renderMenu(); }
            el('painelCadastro').classList.add('open'); el('painelCadastro').scrollIntoView(); el('btnSalvar').innerText="Atualizar"; el('btnCancelar').style.display='block';
        };
        window.limparForm = () => { idEditando=null; el('tituloForm').innerText="Novo Cadastro"; el('nome').value=""; el('descricao').value=""; el('imagem').value=""; el('btnSalvar').innerText="Salvar"; el('btnCancelar').style.display='none'; cardapio=[]; fotosGaleria=[]; renderMenu(); renderGaleria(); };

        // --- AUXILIARES ---
        window.changeCat = () => { const c = el('categoria').value; const s = el('subcategoria'); s.innerHTML=""; if(listaSubs[c]) listaSubs[c].forEach(x=>s.innerHTML+=`<option>${x}</option>`); el('camposPadrao').style.display = c==="Galeria de Fotos"?'none':'block'; el('boxGaleriaManager').style.display = c==="Galeria de Fotos"?'block':'none'; };
        window.addItemMenu = () => { cardapio.push({nome:el('prodNome').value, preco:el('prodPreco').value}); el('prodNome').value=""; renderMenu(); };
        function renderMenu() { el('lista-cardapio-preview').innerHTML = cardapio.map((x,i)=>`<div>${x.nome} <button onclick="cardapio.splice(${i},1);renderMenu()">x</button></div>`).join(''); const s=el('deliveryBrinde'); s.innerHTML=""; cardapio.forEach(c=>s.innerHTML+=`<option>${c.nome}</option>`); }
        window.addFotoGaleria = () => { fotosGaleria.push(el('inputNovaFoto').value); el('inputNovaFoto').value=""; renderGaleria(); };
        function renderGaleria() { el('previewGaleria').innerHTML = fotosGaleria.map((x,i)=>`<div><img src="${x}" style="height:50px"><button onclick="fotosGaleria.splice(${i},1);renderGaleria()">x</button></div>`).join(''); }
        function carregarPalpites() { onSnapshot(query(collection(db,"vip_palpites"), where("cidadeId","==",currentUser.cityId)), s=>{ el('listaPalpites').innerHTML = s.docs.map(d=>`<div class="manager-item"><span>${d.data().numero} - ${d.data().vipNome} (${d.data().brinde})</span></div>`).join(''); }); }
        window.salvarVip = async () => { await addDoc(collection(db,"vips"), {nome:el('vipNome').value, palavra:el('vipPalavra').value}); alert("Salvo"); };
        window.salvarConfigGlobal = async () => { await setDoc(doc(db,"config","geral"),{titulo:el('confNomeCidade').value,zapAdmin:el('confZapAdmin').value},{merge:true});alert("Salvo"); };
        window.salvarConfiguracaoCidade = async () => { if(currentUser.role!=='city') return; await updateDoc(doc(db,"cidades",currentUser.cityId), {fundo:el('inputCidadeFundo').value, logoPatra:el('inputCidadeLogo').value}); alert("Salvo"); };
        window.renderCats = () => { const d=el('listaGestaoCategorias'); d.innerHTML=""; Object.keys(listaSubs).forEach(k => { if(k!=='_order') d.innerHTML+=`<div class="cat-block"><div class="cat-header"><b>${k}</b></div></div>`; }); }
        window.adicionarCategoria = async () => { const n=el('novaCategoriaInput').value; if(n){ listaSubs[n]=[]; await setDoc(doc(db,"config","categorias"), listaSubs); } };
        
        function carregarCacheUsuarios() { onSnapshot(query(collection(db,"users"),where("cidadeId","==",currentUser.cityId)), s=>{ usuariosCache=[]; s.forEach(d=>{ const u=d.data(); const l=todosLocaisCache.find(x=>x.ownerId===d.id); usuariosCache.push({uid:d.id, data:u, loja:l}); }); }); }
        window.filtrarUsuarios = () => { const t=el('buscaUsuarioInput').value.toLowerCase(); el('listaUsuarios').innerHTML = usuariosCache.filter(u=>u.data.nome.toLowerCase().includes(t)).map(u=>`<div class="manager-item"><b>${u.data.nome}</b><br><small>${u.loja?u.loja.nome:'Sem loja'}</small></div>`).join(''); }
    </script>
</body>
</html>