<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gest√£o Completa</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #e9ecef; max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        /* √Årea de Delivery */
        .delivery-box { background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba; display: none; margin-top: 15px; }
        
        /* Estilo do Item do Card√°pio */
        .item-cardapio { 
            display: flex; justify-content: space-between; align-items: center; 
            background: white; padding: 10px; margin: 8px 0; 
            border-radius: 6px; border: 1px solid #ddd; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .thumb-preview { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 15px; background: #eee; border: 1px solid #ccc; }

        /* Bot√µes Gerais */
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; }
        .btn-primary { background: #6f42c1; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #333; display: none; }
        .btn-danger { background: #dc3545; display: none; }
        
        /* Bot√µes Espec√≠ficos (Card√°pio e Categorias) */
        .btn-add { background: #17a2b8; width: auto; padding: 10px 20px; }
        .btn-update-item { background: #ffc107; color: #333; width: auto; padding: 10px 20px; border: 1px solid #e0a800; }
        .btn-clear { background: #6c757d; width: auto; padding: 10px 20px; margin-left: 5px; }
        .btn-plus { background: #28a745; width: 50px; margin: 8px 0; font-size: 20px; display: flex; align-items: center; justify-content: center; }

        /* Bot√µes Pequenos de A√ß√£o (Lista) */
        .btn-mini { width: auto !important; padding: 5px 10px !important; font-size: 12px !important; margin-left: 5px !important; display: inline-block !important; }
        .btn-mini-edit { background: #ffc107; color: #333; }
        .btn-mini-del { background: #dc3545; color: white; }

        .item-lista { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid #007bff; }
    </style>
</head>
<body>
    <script>
        const senha = prompt("üîí Admin: Digite a senha:");
        if (senha !== "1234") { document.body.innerHTML = ""; window.location.href = "index.html"; }
    </script>

    <div class="card" style="border-top: 5px solid #6f42c1;">
        <h2>üèôÔ∏è Configurar Cidade</h2>
        <input type="text" id="confNomeCidade" placeholder="Nome do App">
        <input type="text" id="confImgFundo" placeholder="Link da Imagem de Fundo (URL)">
        <button id="btnSalvarConfig" class="btn-primary">Salvar Apar√™ncia</button>
    </div>

    <div class="card">
        <h2 id="tituloForm">üè™ Gerenciar Locais</h2>
        
        <input type="text" id="nome" placeholder="Nome do Local">
        <input type="text" id="cidade" placeholder="Endere√ßo / Bairro">
        <input type="text" id="imagem" placeholder="Link da Logo/Foto (URL)">

        <label>Contatos:</label>
        <input type="text" id="contato" placeholder="WhatsApp (Somente n√∫meros, ex: 11999999999)">
        <input type="text" id="telFixo" placeholder="Telefone para Ligar (Opcional)">
        <input type="text" id="instagram" placeholder="Link do Instagram/Facebook (URL completa)">

        <label style="margin-top:10px; display:block">Categoria:</label>
        <select id="categoria">
            <option value="">Selecione...</option>
            <option value="Comercio">Com√©rcio</option>
            <option value="Alimentacao">Alimenta√ß√£o</option>
            <option value="Servicos">Servi√ßos</option>
            <option value="Saude">Sa√∫de</option>
            <option value="Publico">√ìrg√£os P√∫blicos</option>
        </select>

        <label>Subcategoria:</label>
        <div style="display: flex; gap: 10px;">
            <select id="subcategoria" disabled>
                <option value="">Selecione uma categoria acima</option>
            </select>
            <button id="btnAddSub" class="btn-plus" title="Adicionar nova">+</button>
        </div>

        <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px; background: #fff3cd; padding: 10px; border-radius: 6px;">
            <input type="checkbox" id="checkDelivery" style="width: 20px; height: 20px; margin: 0;">
            <label for="checkDelivery" style="font-weight: bold; flex: 1;">Faz Delivery / Tem Card√°pio?</label>
            <input type="number" id="taxaEntrega" placeholder="Taxa Entrega (R$)" style="width: 140px; margin: 0; display: none;">
        </div>

        <div id="boxDelivery" class="delivery-box">
            <h3 style="border-bottom: 1px solid #ccc; padding-bottom: 5px;">üçî Montar Card√°pio</h3>
            
            <div style="display: flex; gap: 10px;">
                <input type="text" id="prodNome" placeholder="Nome do Item (Ex: X-Bacon)">
                <input type="number" id="prodPreco" placeholder="Pre√ßo (10.00)" style="width: 100px;">
            </div>
            <input type="text" id="prodDesc" placeholder="Descri√ß√£o (Ex: P√£o, carne, queijo...)">
            <input type="text" id="prodImg" placeholder="Link da Foto do Produto (URL)">
            
            <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                <button id="btnLimparItem" class="btn-clear">Limpar</button>
                <button id="btnAddItem" class="btn-add">Adicionar +</button>
            </div>

            <div id="lista-cardapio-preview" style="margin-top: 20px;"></div>
        </div>

        <button id="btnSalvar" class="btn-success">Cadastrar Local</button>
        <button id="btnAtualizar" class="btn-warning">Confirmar Edi√ß√£o</button>
        <button id="btnCancelar" class="btn-danger">Cancelar</button>
        <div id="statusLocal" style="text-align: center; margin-top: 10px;"></div>
    </div>

    <div class="card" style="background: transparent; box-shadow: none; padding: 0;">
        <h3>üìã Lista de Cadastros</h3>
        <div id="lista-locais">Carregando...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, getDoc, setDoc, onSnapshot, query, orderBy } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDsTWnP2cmsUIDeDlotoR1uELMAba_-dyw",
          authDomain: "testegithub-e1ffb.firebaseapp.com",
          projectId: "testegithub-e1ffb",
          storageBucket: "testegithub-e1ffb.firebasestorage.app",
          messagingSenderId: "508103458559",
          appId: "1:508103458559:web:55bc2fe4dc61d7b5ee16ca"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const el = (id) => document.getElementById(id);
        
        let idEditando = null;
        let cardapioAtual = []; 
        let listaSubs = {};
        let itemMenuEditandoIndex = -1; 

        // 1. CARREGAR SUBCATEGORIAS
        async function carregarSubsDoBanco() {
            try {
                const docSnap = await getDoc(doc(db, "config", "categorias"));
                if (docSnap.exists()) listaSubs = docSnap.data();
                else {
                    listaSubs = { "Comercio": ["Supermercado"], "Alimentacao": ["Lanchonete"] };
                    await setDoc(doc(db, "config", "categorias"), listaSubs);
                }
            } catch (error) {}
        }
        carregarSubsDoBanco();

        el('categoria').addEventListener('change', () => {
            const cat = el('categoria').value;
            const sub = el('subcategoria');
            sub.innerHTML = '<option value="">Selecione...</option>';
            if (!cat) { sub.disabled = true; return; }
            sub.disabled = false;
            (listaSubs[cat] || []).forEach(op => sub.innerHTML += `<option value="${op}">${op}</option>`);
        });

        el('btnAddSub').addEventListener('click', async () => {
            const cat = el('categoria').value;
            if(!cat) return alert("Selecione uma categoria primeiro.");
            const nova = prompt(`Nova subcategoria para ${cat}:`);
            if(!nova) return;
            if(!listaSubs[cat]) listaSubs[cat] = [];
            if(listaSubs[cat].includes(nova)) return alert("J√° existe!");
            listaSubs[cat].push(nova);
            await setDoc(doc(db, "config", "categorias"), listaSubs);
            el('categoria').dispatchEvent(new Event('change'));
            el('subcategoria').value = nova;
        });

        // 2. DELIVERY & CARD√ÅPIO
        el('checkDelivery').addEventListener('change', (e) => {
            el('boxDelivery').style.display = e.target.checked ? 'block' : 'none';
            el('taxaEntrega').style.display = e.target.checked ? 'block' : 'none';
        });

        // Bot√£o Limpar (Resetar Edi√ß√£o do Menu)
        el('btnLimparItem').addEventListener('click', () => {
            el('prodNome').value = ""; el('prodPreco').value = ""; 
            el('prodDesc').value = ""; el('prodImg').value = "";
            itemMenuEditandoIndex = -1;
            el('btnAddItem').textContent = "Adicionar +";
            el('btnAddItem').className = "btn-add";
            el('prodNome').focus();
        });

        // Adicionar ou Atualizar Item do Menu
        el('btnAddItem').addEventListener('click', () => {
            const nome = el('prodNome').value;
            const preco = parseFloat(el('prodPreco').value);
            const desc = el('prodDesc').value;
            const img = el('prodImg').value;

            if(!nome || !preco) return alert("Preencha nome e pre√ßo");

            const itemObj = { nome, preco, desc, img };

            if (itemMenuEditandoIndex === -1) {
                cardapioAtual.push(itemObj); // Novo
            } else {
                cardapioAtual[itemMenuEditandoIndex] = itemObj; // Atualiza
                el('btnLimparItem').click(); // Sai do modo edi√ß√£o
            }
            renderCardapio();
            if(itemMenuEditandoIndex === -1) el('btnLimparItem').click(); // Limpa se for novo
        });

        // Renderiza a lista do menu com bot√µes vis√≠veis
        function renderCardapio() {
            const div = el('lista-cardapio-preview');
            div.innerHTML = "";
            
            cardapioAtual.forEach((item, index) => {
                const imgTag = item.img ? `<img src="${item.img}" class="thumb-preview">` : `<div class="thumb-preview"></div>`;
                
                div.innerHTML += `
                    <div class="item-cardapio">
                        <div style="display:flex; align-items:center; flex:1;">
                            ${imgTag}
                            <div>
                                <div style="font-weight:bold; font-size:15px;">${item.nome}</div>
                                <div style="font-size:13px; color:#666;">R$ ${item.preco.toFixed(2)}</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button type="button" class="btn-mini btn-mini-edit" onclick="editarItemMenu(${index})">EDITAR</button>
                            <button type="button" class="btn-mini btn-mini-del" onclick="removeDoMenu(${index})">X</button>
                        </div>
                    </div>`;
            });
        }
        
        // Fun√ß√µes Globais para os bot√µes do HTML funcionarem
        window.removeDoMenu = (index) => {
            if(confirm("Remover item?")) {
                cardapioAtual.splice(index, 1);
                renderCardapio();
            }
        }

        window.editarItemMenu = (index) => {
            const item = cardapioAtual[index];
            el('prodNome').value = item.nome;
            el('prodPreco').value = item.preco;
            el('prodDesc').value = item.desc || "";
            el('prodImg').value = item.img || "";
            
            itemMenuEditandoIndex = index;
            el('btnAddItem').textContent = "‚úì Salvar Altera√ß√£o";
            el('btnAddItem').className = "btn-update-item";
            el('prodNome').focus();
            
            // Rola um pouco a tela para mostrar os campos
            el('boxDelivery').scrollIntoView({ behavior: 'smooth' });
        }

        // 3. CRUD LOJAS
        function limparForm() {
            idEditando = null;
            cardapioAtual = [];
            el('nome').value = ""; el('cidade').value = ""; el('imagem').value = "";
            el('contato').value = ""; el('telFixo').value = ""; el('instagram').value = "";
            el('checkDelivery').checked = false;
            el('taxaEntrega').value = ""; el('taxaEntrega').style.display = 'none';
            el('boxDelivery').style.display = 'none';
            el('categoria').value = "";
            el('subcategoria').innerHTML = "<option>Selecione...</option>";
            el('subcategoria').disabled = true;
            
            el('btnLimparItem').click(); // Limpa inputs do menu
            renderCardapio();
            
            el('btnSalvar').style.display = 'block';
            el('btnAtualizar').style.display = 'none';
            el('btnCancelar').style.display = 'none';
            el('tituloForm').textContent = "üè™ Gerenciar Locais";
        }
        el('btnCancelar').addEventListener('click', limparForm);

        el('btnSalvar').addEventListener('click', async () => {
            if(!el('nome').value) return alert("Nome obrigat√≥rio");
            el('statusLocal').textContent = "Salvando...";
            try {
                await addDoc(collection(db, "guia_cidades"), {
                    nome: el('nome').value,
                    nomeBusca: el('nome').value.toLowerCase(),
                    cidade: el('cidade').value,
                    categoria: el('categoria').value,
                    subcategoria: el('subcategoria').value,
                    contato: el('contato').value,
                    telFixo: el('telFixo').value,
                    instagram: el('instagram').value,
                    imagem: el('imagem').value || "https://via.placeholder.com/150",
                    temDelivery: el('checkDelivery').checked,
                    taxaEntrega: parseFloat(el('taxaEntrega').value) || 0,
                    cardapio: cardapioAtual,
                    dataCadastro: new Date()
                });
                el('statusLocal').textContent = "‚úÖ Cadastrado!";
                limparForm();
            } catch (e) { alert("Erro: " + e); }
        });

        el('btnAtualizar').addEventListener('click', async () => {
            if(!idEditando) return;
            try {
                await updateDoc(doc(db, "guia_cidades", idEditando), {
                    nome: el('nome').value,
                    nomeBusca: el('nome').value.toLowerCase(),
                    cidade: el('cidade').value,
                    categoria: el('categoria').value,
                    subcategoria: el('subcategoria').value,
                    contato: el('contato').value,
                    telFixo: el('telFixo').value,
                    instagram: el('instagram').value,
                    imagem: el('imagem').value,
                    temDelivery: el('checkDelivery').checked,
                    taxaEntrega: parseFloat(el('taxaEntrega').value) || 0,
                    cardapio: cardapioAtual
                });
                alert("Atualizado!");
                limparForm();
            } catch (e) { alert("Erro: " + e); }
        });

        onSnapshot(query(collection(db, "guia_cidades"), orderBy("dataCadastro", "desc")), (snap) => {
            const lista = el('lista-locais');
            lista.innerHTML = "";
            snap.forEach((d) => {
                const item = d.data();
                const div = document.createElement('div');
                div.className = "item-lista";
                div.innerHTML = `
                    <div><strong>${item.nome}</strong><br><small>${item.categoria}</small></div>
                    <div class="acoes">
                        <button class="btn-mini btn-mini-edit" id="e-${d.id}">EDITAR</button>
                        <button class="btn-mini btn-mini-del" id="d-${d.id}">EXCLUIR</button>
                    </div>`;
                lista.appendChild(div);

                el(`d-${d.id}`).addEventListener('click', () => { if(confirm("Apagar local?")) deleteDoc(doc(db, "guia_cidades", d.id)); });
                el(`e-${d.id}`).addEventListener('click', () => {
                    idEditando = d.id;
                    el('nome').value = item.nome;
                    el('cidade').value = item.cidade;
                    el('imagem').value = item.imagem || "";
                    el('contato').value = item.contato || "";
                    el('telFixo').value = item.telFixo || "";
                    el('instagram').value = item.instagram || "";
                    
                    el('categoria').value = item.categoria;
                    el('categoria').dispatchEvent(new Event('change'));
                    setTimeout(() => { el('subcategoria').value = item.subcategoria; }, 200);

                    el('checkDelivery').checked = item.temDelivery || false;
                    el('taxaEntrega').value = item.taxaEntrega || "";
                    el('taxaEntrega').style.display = item.temDelivery ? 'block' : 'none';
                    el('boxDelivery').style.display = item.temDelivery ? 'block' : 'none';
                    cardapioAtual = item.cardapio || [];
                    renderCardapio();
                    
                    el('btnSalvar').style.display = 'none';
                    el('btnAtualizar').style.display = 'inline-block';
                    el('btnCancelar').style.display = 'inline-block';
                    el('tituloForm').textContent = "‚úèÔ∏è Editando: " + item.nome;
                    window.scrollTo({ top: 300, behavior: 'smooth' });
                });
            });
        });

        async function carregarConfig() {
            try {
                const docSnap = await getDoc(doc(db, "config", "geral"));
                if(docSnap.exists()) {
                    el('confNomeCidade').value = docSnap.data().titulo || "";
                    el('confImgFundo').value = docSnap.data().fundo || "";
                }
            } catch(e) {}
        }
        carregarConfig();
        el('btnSalvarConfig').addEventListener('click', async () => {
            await setDoc(doc(db, "config", "geral"), {
                titulo: el('confNomeCidade').value,
                fundo: el('confImgFundo').value
            }, { merge: true });
            alert("Apar√™ncia Salva!");
        });
    </script>
</body>
</html>