<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Perfil</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        /* RESET E CONFIGURA√á√ïES GERAIS */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; -webkit-user-select: none; user-select: none; }
        
        body { 
            background: #ffffff; 
            min-height: 100vh; 
            width: 100vw; 
            display: flex; 
            flex-direction: column; 
            overflow-x: hidden; 
            /* Espa√ßo para o banner quadrado n√£o cobrir o conte√∫do */
            padding-bottom: 105vw; 
        }

        /* Ajuste para telas maiores (PC/Tablet) */
        @media (min-width: 500px) {
            body {
                background: #333; 
                padding-bottom: 0; 
                align-items: center; 
            }
            #app-shell {
                width: 100%;
                max-width: 500px;
                background: white;
                min-height: 100vh;
                position: relative;
                padding-bottom: 520px; 
                display: flex;
                flex-direction: column;
                box-shadow: 0 0 20px rgba(0,0,0,0.5);
            }
        }
        
        /* CAPA (Hero) - Altura Fixa */
        .hero-container { 
            width: 100%; 
            height: 220px; 
            position: relative; 
            background: #333; 
            flex-shrink: 0; 
        }
        .hero { width: 100%; height: 100%; object-fit: cover; cursor: pointer; display: block; }
        
        /* CONTE√öDO (Centro) */
        .bottom-wrapper { 
            width: 100%; 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: white; 
            border-radius: 25px 25px 0 0; 
            margin-top: -25px; 
            padding-top: 10px; 
            position: relative; 
            z-index: 10; 
        }
        
        .info-card { background: white; padding: 10px 20px 20px 20px; }
        .header-row { display: flex; justify-content: space-between; align-items: flex-start; }
        h1 { margin: 0; font-size: 20px; color: #222; font-weight: 800; }
        
        .price-badge { text-align: right; }
        .price-val { font-size: 18px; font-weight: bold; color: #28a745; display: block; }
        .old-price-val { font-size: 11px; text-decoration: line-through; color: #999; }
        .sub-info { color: #666; margin-top: 4px; font-size: 13px; }
        
        /* BOT√ïES */
        .actions-bar { display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap; }
        .btn-action { flex: 1; padding: 10px 0; border-radius: 8px; text-decoration: none; color: white; font-weight: bold; text-align: center; font-size: 11px; display: none; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-transform: uppercase; cursor: pointer; min-width: 70px; }
        .btn-call { background: #007bff; } 
        .btn-whats { background: #25D366; } 
        .btn-insta { background: #E1306C; } 
        .btn-delivery { background: #ff9800; color: #333; border: 1px solid #e68900; }
        .btn-maps { background: #4285F4; }
        .btn-gallery { background: #6f42c1; } 

        /* √ÅREAS INTERNAS */
        .menu-section { display: none; background: white; margin-top: 10px; padding: 15px; border-top: 1px solid #eee; }
        .menu-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .btn-add { background: #28a745; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; }

        .gallery-section { display: none; background: white; margin-top: 10px; padding: 15px; border-top: 1px solid #eee; }
        .grid-thumbs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .grid-thumb-img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 8px; cursor: pointer; border: 1px solid #ddd; }

        /* --- BANNER PUBLICIT√ÅRIO FIXO (QUADRADO) --- */
        #box-publicidade-fixa {
            position: fixed;
            bottom: 0;
            left: 50%; 
            transform: translateX(-50%); 
            width: 100%;
            max-width: 500px; 
            aspect-ratio: 1 / 1; 
            height: auto;
            background-color: #000;
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.5);
        }

        #imgBannerFixo { width: 100%; height: 100%; object-fit: contain; display: block; }

        /* CARRINHO */
        .fab-cart { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: #ffc107; 
            color: #333; 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            font-size: 20px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            z-index: 10000; 
            transition: bottom 0.3s;
        }
        
        @media (min-width: 500px) {
            .fab-cart { right: calc(50% - 230px); }
        }

        .cart-badge { position: absolute; top: -5px; right: -5px; background: red; color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10001; display: none; align-items: flex-end; justify-content: center; }
        .modal-content { background: white; width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; padding: 20px; max-height: 85vh; display: flex; flex-direction: column; }
        
        /* LIGHTBOX */
        .lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 12000; display: none; align-items: center; justify-content: center; }
        .lightbox img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .btn-close-lightbox { position: absolute; top: 20px; right: 20px; color: white; background: rgba(0,0,0,0.5); border: none; font-size: 30px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; z-index: 12002; }
        .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.3); color: white; border: none; font-size: 40px; padding: 10px; cursor: pointer; z-index: 12001; }
        .nav-prev { left: 10px; }
        .nav-next { right: 10px; }
        
        /* BOT√ÉO VOLTAR FLUTUANTE */
        .btn-back-float {
            position: absolute; 
            top: 15px; 
            left: 15px; 
            background: rgba(0,0,0,0.5); 
            color: white; 
            padding: 5px 15px; 
            border-radius: 20px; 
            text-decoration: none; 
            font-weight: bold; 
            z-index: 50;
            cursor: pointer;
            border: none;
            font-size: 14px;
        }
    </style>
</head>
<body>
    
    <div id="app-shell">
        <button onclick="voltarSeguro()" class="btn-back-float">‚¨Ö Voltar</button>
        
        <div class="hero-container"><img id="capa" class="hero" src="" onclick="abrirLightbox(0)"></div>
        
        <div class="bottom-wrapper">
            <div class="info-card">
                <div class="header-row">
                    <div><h1 id="nome">...</h1><p class="sub-info" id="cats">...</p></div>
                    <div id="priceBox" class="price-badge" style="display:none;">
                        <div id="oldPrice" class="old-price-val"></div>
                        <div id="currPrice" class="price-val"></div>
                    </div>
                </div>
                <p class="sub-info" id="endereco">...</p>
                
                <div class="actions-bar">
                    <a id="btnLigar" href="#" class="btn-action btn-call">LIGAR</a>
                    <a id="btnZapPerfil" href="#" class="btn-action btn-whats">WHATS</a>
                    <a id="btnInsta" href="#" class="btn-action btn-insta" target="_blank">INSTA</a>
                    <a id="btnRota" href="#" class="btn-action btn-maps" target="_blank">üìç ROTA</a>
                    <div id="btnGaleria" class="btn-action btn-gallery" onclick="alternarGaleria()">üì∑ GALERIA</div>
                    <div id="btnDelivery" class="btn-action btn-delivery" onclick="alternarDelivery()">DELIVERY</div>
                </div>
            </div>

            <div id="area-galeria" class="gallery-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><h3 style="margin:0">Galeria de Fotos</h3><button onclick="alternarGaleria()" style="background:none;border:none;font-size:20px">‚úï</button></div>
                <div id="grid-fotos" class="grid-thumbs"></div>
            </div>

            <div id="area-cardapio" class="menu-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><h3 style="margin:0">Card√°pio</h3><button onclick="alternarDelivery()" style="background:none;border:none;font-size:20px">‚úï</button></div>
                <div id="lista-produtos"></div>
            </div>
        </div>
    </div>

    <div id="box-publicidade-fixa">
        <img id="imgBannerFixo" src="" alt="Publicidade">
    </div>

    <div id="btnCart" class="fab-cart" onclick="abrirCarrinho()">üõí<div id="cartCount" class="cart-badge">0</div></div>
    
    <div id="cartModal" class="modal-overlay" onclick="fecharCarrinho(event)"><div class="modal-content" onclick="event.stopPropagation()"><div style="display:flex; justify-content:space-between; margin-bottom:15px;"><span style="font-weight:bold">Seu Pedido</span><button onclick="fecharCarrinho()" style="background:none; border:none; font-size:24px">√ó</button></div><div id="cartItemsList" style="overflow-y:auto; flex:1"></div><button id="btnFinalizarZap" style="background:#25D366; color:white; width:100%; padding:12px; border:none; margin-top:10px; border-radius:8px; font-weight:bold;">Enviar Pedido</button></div></div>
    
    <div id="lightbox" class="lightbox" onclick="fecharSeForFundo(event)">
        <button class="btn-close-lightbox" onclick="fecharFotoCapa()">√ó</button>
        <button class="nav-btn nav-prev" onclick="mudarFoto(-1, event)">‚ùÆ</button>
        <img id="imgLightbox" src="">
        <button class="nav-btn nav-next" onclick="mudarFoto(1, event)">‚ùØ</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyDsTWnP2cmsUIDeDlotoR1uELMAba_-dyw", authDomain: "testegithub-e1ffb.firebaseapp.com", projectId: "testegithub-e1ffb", storageBucket: "testegithub-e1ffb.firebasestorage.app", messagingSenderId: "508103458559", appId: "1:508103458559:web:55bc2fe4dc61d7b5ee16ca" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);
        
        const params = new URLSearchParams(window.location.search); const id = params.get('id');
        let localData = null, carrinho = [], bannersCache = [];
        let allImages = []; 
        let currentImgIdx = 0; 
        
        // --- NOVA FUN√á√ÉO DE VOLTAR INTELIGENTE ---
        window.voltarSeguro = () => {
            if (window.history.length > 1) {
                window.history.back(); // Volta para a lista anterior
            } else {
                window.location.href = 'index.html'; // Fallback para Home
            }
        };

        async function carregarDetalhes() {
            if(!id) return window.location.href = "index.html";
            const docSnap = await getDoc(doc(db, "guia_cidades", id));
            if (docSnap.exists()) {
                localData = docSnap.data();
                
                allImages = (localData.imagens && localData.imagens.length > 0) ? localData.imagens : (localData.imagem ? [localData.imagem] : ["https://via.placeholder.com/400x200"]);
                document.getElementById('capa').src = allImages[0];
                
                if(allImages.length > 1) { document.getElementById('btnGaleria').style.display = 'flex'; }

                document.getElementById('nome').textContent = localData.nome;
                document.getElementById('cats').textContent = `${localData.categoria} > ${localData.subcategoria || ''}`;
                document.getElementById('endereco').textContent = localData.cidade;

                if(localData.preco > 0) {
                    document.getElementById('priceBox').style.display = 'block';
                    document.getElementById('currPrice').textContent = `R$ ${localData.preco.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    if(localData.precoAntigo > 0) document.getElementById('oldPrice').textContent = `R$ ${localData.precoAntigo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                }

                if(localData.telFixo) { const btn = document.getElementById('btnLigar'); btn.href = `tel:${localData.telFixo.replace(/\D/g,'')}`; btn.style.display = 'flex'; }
                if(localData.contato) { const btn = document.getElementById('btnZapPerfil'); btn.href = `https://wa.me/55${localData.contato.replace(/\D/g,'')}`; btn.style.display = 'flex'; }
                if(localData.categoria !== 'Classificados' && localData.instagram) { const btn = document.getElementById('btnInsta'); btn.href = localData.instagram; btn.style.display = 'flex'; }

                const btnRota = document.getElementById('btnRota');
                if(localData.linkMapa) { btnRota.href = localData.linkMapa; btnRota.style.display = 'flex'; } 
                else if (localData.cidade) { const busca = encodeURIComponent(localData.cidade + " " + localData.nome); btnRota.href = `https://www.google.com/maps/search/?api=1&query=${busca}`; btnRota.style.display = 'flex'; }

                if(localData.temDelivery) {
                    document.getElementById('btnDelivery').style.display = 'flex';
                    const lista = document.getElementById('lista-produtos');
                    (localData.cardapio||[]).forEach((item, index) => {
                        lista.innerHTML += `<div class="menu-item"><div style="display:flex;align-items:center;"><div><strong>${item.nome}</strong><br><small>R$ ${parseFloat(item.preco).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</small></div></div><button class="btn-add" onclick="addCart(${index})">+</button></div>`;
                    });
                }
                
                renderizarGradeGaleria();
            }
            inicializarPublis();
        }

        window.alternarGaleria = () => {
            const galeria = document.getElementById('area-galeria');
            const menu = document.getElementById('area-cardapio');
            menu.style.display = 'none';
            if (galeria.style.display === 'block') { galeria.style.display = 'none'; } else { galeria.style.display = 'block'; }
        };

        window.alternarDelivery = () => {
            const galeria = document.getElementById('area-galeria');
            const menu = document.getElementById('area-cardapio');
            galeria.style.display = 'none';
            if (menu.style.display === 'block') { menu.style.display = 'none'; } else { menu.style.display = 'block'; }
        };

        function renderizarGradeGaleria() {
            const div = document.getElementById('grid-fotos');
            div.innerHTML = "";
            allImages.forEach((src, idx) => {
                div.innerHTML += `<img src="${src}" class="grid-thumb-img" onclick="abrirLightbox(${idx})">`;
            });
        }

        window.abrirLightbox = (idx = 0) => { currentImgIdx = idx; atualizarLightbox(); document.getElementById('lightbox').style.display = 'flex'; }
        window.atualizarLightbox = () => { document.getElementById('imgLightbox').src = allImages[currentImgIdx]; }
        window.mudarFoto = (dir, e) => { if(e) e.stopPropagation(); currentImgIdx += dir; if(currentImgIdx < 0) currentImgIdx = allImages.length - 1; if(currentImgIdx >= allImages.length) currentImgIdx = 0; atualizarLightbox(); }
        window.fecharFotoCapa = () => { document.getElementById('lightbox').style.display = 'none'; }
        window.fecharSeForFundo = (e) => { if(e.target.id === 'lightbox') fecharFotoCapa(); }

        // --- SISTEMA DE PUBLICIDADE (BANNER) ---
        async function inicializarPublis() { 
            try { 
                const snap = await getDocs(collection(db, "guia_cidades")); 
                snap.forEach(d => { 
                    const dt = d.data(); 
                    if(dt.publi && dt.publi.ativa && dt.publi.img) { 
                        bannersCache.push({img: dt.publi.img, id: d.id}); 
                    } 
                }); 
                if(bannersCache.length > 0) { 
                    mostrarNovaPubli(); 
                    setInterval(mostrarNovaPubli, 60000); 
                } 
            } catch(e){} 
        }
        
        function mostrarNovaPubli() { 
            if(bannersCache.length === 0) return; 
            const item = bannersCache[Math.floor(Math.random() * bannersCache.length)]; 
            
            const img = document.getElementById('imgBannerFixo'); 
            const box = document.getElementById('box-publicidade-fixa');
            
            img.src = item.img; 
            img.onclick = () => window.location.href=`detalhes.html?id=${item.id}`; 
            
            box.style.display = 'flex'; 
            
            // Ajusta o carrinho para subir
            const btnCart = document.getElementById('btnCart');
            btnCart.style.bottom = "calc(100vw + 20px)"; 
            
            if(window.innerWidth >= 500) {
                 btnCart.style.bottom = "540px";
            }
        }

        window.addCart = (idx) => { const item = localData.cardapio[idx]; carrinho.push(item); atualizarCarrinho(); };
        function atualizarCarrinho() {
            document.getElementById('cartCount').textContent = carrinho.length;
            document.getElementById('btnCart').style.display = carrinho.length > 0 ? 'flex' : 'none';
            const lista = document.getElementById('cartItemsList');
            lista.innerHTML = "";
            let total = 0;
            carrinho.forEach((item, i) => {
                total += parseFloat(item.preco);
                lista.innerHTML += `<div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee"><span>${item.nome}</span><span>R$ ${parseFloat(item.preco).toLocaleString('pt-BR', {minimumFractionDigits: 2})} <button onclick="removeCart(${i})" style="color:red;border:none;background:none">x</button></span></div>`;
            });
            document.getElementById('btnFinalizarZap').textContent = `Enviar Pedido - Total: R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('btnFinalizarZap').onclick = () => {
                let msg = `Ol√°, gostaria de pedir:\n`;
                carrinho.forEach(i => msg += `- ${i.nome}\n`);
                msg += `Total: R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                window.open(`https://wa.me/55${localData.contato.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`);
            }
        }
        window.removeCart = (i) => { carrinho.splice(i,1); atualizarCarrinho(); };
        window.abrirCarrinho = () => document.getElementById('cartModal').style.display='flex';
        window.fecharCarrinho = () => document.getElementById('cartModal').style.display='none';

        carregarDetalhes();
    </script>
</body>
</html>